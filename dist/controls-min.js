!function(t,e){if("function"==typeof define&&define.amd)define(["Box","jQuery"],e);else{e(Box,$)}}(0,function(t,e){var i;function o(i,o){var n=this;this.cid=t._.uniqueId("view"),this.$el=this.$el||e(i),this.options=this.options||e.extend({},t.UI.Control.defaults,this.$el.data(),o||{}),this.p=this.p||Promise.resolve(),this.p.then(function(){var t;if(!n.options.domLink)return Promise.resolve();(t=n.$el.data(n.options.domLink))&&"function"==typeof t.destroy&&(t.destroy(),n.options[n.options.domLink]&&(n.options[n.options.domLink]=null)),n.$el.data(n.options.domLink,n)}).then(function(){return n.initialize()})}t.UI=t.UI||{};var n=/^(\S+)\s*(.*)$/;function s(i,o){this.$el=this.$el||e(i),this.options=this.options||e.extend({},t.UI.View.defaults,this.$el.data(),o||{}),this.$container=this.$el.find(this.options.selectContainer),this.$messages=this.$el.find(this.options.messagesContainer),this.childrens=[],t.UI.Control.call(this,i,this.options)}function r(i,o){this.$el=this.$el||e(i),this.options=this.options||e.extend({},t.UI.Select.defaults,this.$el.data(),o||{}),this.options.className=this.options.className||this.$el.data("field-target"),this.options.field=this.options.field||this.$el.data("bm-field").split("$")[1],this.options.parentClass=this.options.parentClass||this.$el.data("bm-field").split("$")[0],this.options.searchFor=this.options.searchFor||e(i).data("search-for")||t.UI.Select.defaults.mapSearch[this.options.className]||"name",this.options.relation=this.options.relation||"Relation"===this.$el.data("field-type"),this.options.preload=this.options.preload||!!this.$el.data("preload"),t.UI.Control.call(this,i,e.extend({},t.UI.Select.defaults,o||{}))}function a(i,o){this.$el=this.$el||e(i),this.options=this.options||e.extend({},t.UI.DataTable.defaults,this.$el.data(),o||{}),this.options.className=this.options.className||this.$el.data("class-name"),this.queryOptions=this.options.query||{},this.where=this.options.where||{},this._include=this.options.include||this.$el.data("query-include"),this._storageKey=this._storageKey||this.$el.attr("id")||"DataSet:"+this.options.className+"#"+(this.$el.parents(".jarviswidget").eq(0).attr("id")||"")+":"+(t.User.current()?t.User.current().id:"*"),t.UI.Control.call(this,i,e.extend({},t.UI.DataTable.defaults,o||{}))}function l(i,o){this.$el=e(i),this.options=e.extend({},t.UI.PivotTable.defaults,o||{}),t.UI.Control.call(this,i,this.options)}function c(i,o){this.$el=this.$el||e(i),this.options=this.options||e.extend({},t.UI.Editor.defaults,e(this.$el).data(),o||{}),this.readOnly=!0,this.selects=this.selects||{},this.files=this.files||{},t.UI.Control.call(this,i)}function d(i,o){this.$el=this.$el||e(i),this.options=this.options||e.extend({},t.UI.DataSet.defaults,this.$el.data(),o||{}),this.options.className=this.options.className||this.$el.data("class-name"),void 0===this.options.createNew&&(this.options.createNew=!!this.$el.data("acl-create")),t.UI.Control.call(this,i)}e.extend(o.prototype,t.Events,{$:function(t){return this.$el.find(t)},destroy:function(){return this.trigger("destroy"),this._removeElement(),this.stopListening(),this.p},_removeElement:function(){this.$el.remove()},initialize:function(){var e=this,i=Array.prototype.slice.call(arguments);return this.options.events&&this.delegateEvents(this.options.events),this.options.controller&&(this.p=this.p.then(function(){return t.Utils.require(e.options.controller.src||e.options.controller).then(function(t){"function"==typeof t?e.controller=new t(e):t&&"function"==typeof t.getController?e.controller=t.getController(e):t&&"function"==typeof t.init&&t.init.call(e,e.$el)})})),this.p.then(function(){return e.trigger("initialized"),e.render.apply(e,i)})},render:function(){return this.trigger("rendered"),this.p},show:function(){this.trigger("show"),this.$el.show()},hide:function(){this.trigger("hide"),this.$el.hide()},delegateEvents:function(e){if(!(e=e||(e=t._.result(this,"events"))))return this;for(var i in this.undelegateEvents(),e){var o=e[i];if(t._.isFunction(o)||(o=this[o]),o){var s=i.match(n);this.delegate(s[1],s[2],t._.bind(o,this))}}return this},delegate:function(t,e,i){return this.$el.on(t+".delegateEvents"+this.cid,e,i),this.on(t,i),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this.off(),this},undelegate:function(t,e,i){return this.$el.off(t+".delegateEvents"+this.cid,e,i),this.off(t,i),this},_setAttributes:function(t){this.$el.attr(t)}}),o.prototype.constructor=o,t.UI.Control=o,t.UI.Control.defaults={domLink:"box.control",constructorClass:"box.constructor"},s.prototype=Object.create(o.prototype),s.prototype.constructor=s,s.prototype.initialize=function(){var e=this;return t.UI.Control.prototype.initialize.call(this).then(function(){return e.loadChildrens()})},s.prototype.showMessage=function(t){return this.$messages.html(t)},s.prototype.cleanChildrens=function(){var t,i=this,o=[],n=e.grep(this.childrens||[],function(t){return"function"==typeof t.destroy});for(t=0;t<n.length;t++)o.push(n[t].destroy());return e.when.apply(e,o).then(function(){for(var t,e=(i.childrens||[]).length;e--;)"function"==typeof(t=i.childrens.pop()).destroy&&t.destroy(),delete t;return i.childrens=[],Promise.resolve()})},s.prototype.loadChildrens=function(i){var o=[],n=this;return this.p=this.p.then(function(){return n.$container.find(n.options.childControls).each(function(s,r){var a,l,c=e(r).data("controller");if("function"==typeof n.options.childConstructor)return l=new n.options.childConstructor(r,i),n.childrens.push(l),void(l.p&&o.push(l.p));c&&(a=t.Utils.require(c).then(function(t){if(t&&"function"==typeof t.init)return t.init(r,n,i)}).then(function(){var t=e(r).data(n.options.domLink);t&&n.childrens.push(t)}).catch(function(e){t.Trace.captureException(e)}),o.push(a))}),Promise.all(o)}),this.p},s.prototype.load=function(i,o){var n=this;return o&&(i=i+"?"+t.Utils.querystring.stringify(o)),e.ajax({type:"GET",url:i,dataType:"html",beforeSend:function(e){n.showMessage(t.UI.View.defaults.loadingHtml),n.$container.css({opacity:"0.0"})}}).then(function(t){return n.cleanChildrens().then(function(){return n.$messages.hide(),n.$container.html(t).delay(50).animate({opacity:"1.0"},300),n.loadChildrens(o)})},function(e,o,s){n.showMessage(t.UI.View.defaults.errorHtml.format({url:i,status:e.status,err:s})),n.$container.animate({opacity:"1.0"},300)})},s.prototype.destroy=function(){var e=this;return this.cleanChildrens().then(function(){return t.UI.Control.prototype.destroy.call(e)})},t.UI.View=s,t.UI.View.defaults=e.extend({},t.UI.Control.defaults,{loadingHtml:'<h1 class="ajax-loading-animation"><i class="fa fa-cog fa-spin"></i> Loading...</h1>',errorHtml:'<h4 class="ajax-loading-error"><i class="fa fa-warning txt-color-orangeDark"></i> Error requesting <span class="txt-color-red">{url}</span>: {status} <span style="text-transform: capitalize;"> {err}</span></h4>',selectContainer:"box-content-container",messagesContainer:"box-messages-container",childControls:"[data-controller]"}),r.prototype=Object.create(o.prototype),r.prototype.constructor=r,r.prototype.initialize=function(){var i=this;return t.UI.Control.prototype.initialize.call(this).then(function(){return new Promise(function(o,n){var s=Promise.resolve(),r=i.options;return i.query?o():(this.__initial=[],i.query=r.query||new t.Query(r.className),e.fn.select2||(s=t.Utils.require(["select2"])),s.then(function(){var t={};if(void 0!==r.useMasterKey&&(t.useMasterKey=r.useMasterKey),r.preload)return i.query.find(t).then(function(t){var o=e.map(t,function(t){return'<option value="'+encodeURI(t.id)+'">'+t.get(i.options.searchFor)+"</option>"}).join("");i.$el.html(o),i.$el.select2(e.extend({width:r.relation?"100%":r.width,allowClear:!0},r))});i.$el.select2(e.extend({width:r.relation?"100%":r.width,minimumInputLength:i.options.minimumInputLength||3,allowClear:!i.options.bmRequired,placeholder:"Select "+i.options.className,ajax:{delay:250,transport:function(e,o,n){i.query.matches(i.options.searchFor,new RegExp(e.data.q.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi")),i.query.find(t).then(function(t){o(t)},function(t){n(t)})},processResults:function(t,o){return{results:e.map(t,function(t){return{id:t.id,text:t.get(i.options.searchFor)}})}}}},r)),i.options.bmRequired||i.$el.on("select2:unselect",function(t){i.$el.empty()})}).then(o,n))})})},r.prototype.val=function(i,o){var n=this;return this.options.preload?n.$el.val(i).trigger("change"):this.p=this.p.then(function(){var s,r=o||new t.Query(n.options.className);return n.$el.empty().trigger("change"),i?(n.options.relation&&!o?r=i.parent.relation(n.options.field).query():"string"==typeof i&&r.equalTo("objectId",i),n.options.useMasterKey&&(s={useMasterKey:!0}),r.find(s).then(function(t){n.__initial=t,n.$el.html(e.map(t,function(t){return n.options.relation,'<option value="{id}" selected="selected">{text}</option>'.format({id:t.id,text:t.get(n.options.searchFor)})}).join("")).trigger("change")})):Promise.resolve()}),this.p},r.prototype.syncRelation=function(i){var o=this;return this.p=this.p.then(function(){var n=o.$el.val();if(!o.options.relation||!i)return Promise.resolve();e.each(o.__initial,function(t,e){-1===n.indexOf(e.id)&&i.relation(o.options.field).remove(e)}),e.each(n,function(n,s){e.grep(o.__initial,function(t){return t.id===s}).length||i.relation(o.options.field).add(t.Object.fromJSON({className:o.options.className,objectId:s}))})}),this.p},r.prototype.destroy=function(){return this.$el.select2("destroy"),t.UI.Control.prototype.destroy.call(this)},t.UI.Select=r,t.UI.Select.defaults=e.extend({},t.UI.Control.defaults,{width:"250px",mapSearch:{_User:"username",Files:"fileName"}}),a.prototype=Object.create(o.prototype),a.prototype.constructor=a,a.prototype._exportData=function(i,o,n,s){o.settings()[0].aoColumns;var r=o.columns(":visible")[0].map(function(t){return o.settings()[0].aoColumns[t].field});t.CoreManager.getRESTController().request("POST","tasks/create",{query:this.__qcache,className:this.options.className,items:r,title:"Export "+this.options.className+" items",content:"Export task will be created, when data is ready you will be notified",type:"export"}).then(function(i){return t.Utils.require("notification").then(function(){e.notify({message:"Export data task created",type:"info",icon:"fa fa-download"},{timeout:5e3})})},function(e){t.Utils.require("notification").then(function(){t.Trace.captureException(e)})})},a.prototype.initialize=function(){var o=this,n={responsive:!0,deferRender:!0,serverSide:!0,processing:!0,ajax:function(i,n,s){function r(s){if(s.limit(i.length),i.start&&s.skip(i.start),i.order&&i.order.length){var r=i.columns[i.order[0].column].data;"asc"===i.order[0].dir?s.ascending(r):s.descending(r)}o._include&&s.include(o._include),s.find(o.queryOptions).then(function(t){var s={draw:i.draw,recordsTotal:o.___totalCount||0,recordsFiltered:o.___count,data:e.map(t,function(t){var o={DT_RowData:t};return e.each(i.columns,function(e,i){var n,s;""!==i.data&&(n=i.data.split("."),s=void 0!==t.get(n[0])?t.get(n[0]):t[n[0]],n.length>1?(o[n[0]]=o[n[0]]||{},o[n[0]][n[1]]=s?s.get(n[1]):null):o[n[0]]=s)}),o})};o._records=t,o.trigger("changed",t),n(s)}).catch(function(e){t.Trace.captureException(e),o.trigger("changed"),n({draw:i.draw,data:[],recordsTotal:0,recordsFiltered:0})})}if(o.where&&Object.keys(o.where).length&&o.where.parentClass&&o.where.fieldId&&o.where.objectId){var a=t.Object.fromJSON({className:o.where.parentClass,objectId:o.where.objectId});rqp=a.relation(o.where.fieldId).query()}("function"==typeof o.options.getSearchQuery?o.options.getSearchQuery:o.getSearchQuery).call(o,i.search?i.search.value:void 0).then(function(t){var e=JSON.stringify(t.toJSON());return o.__qcache===e?r(t):t.count(o.queryOptions).then(function(n){return i.search&&i.search.value&&""!==i.search.value||(o.___totalCount=n),o.___count=n,o.__qcache=e,r(t)},function(t){return o.onError(t),n({draw:i.draw,data:[],recordsTotal:0,recordsFiltered:0,error:t.message||t})})})}};if(e.each(this.options,function(t,e){"dt"===t.substring(0,2)&&(t=t.substring(2),n[t]=e)}),this._requires=["dataTablesResponsiveBoostrap"],n.columns&&n.columns.length||(n.columns=n.columns||this._getColumns()),!n.order)for(var s=0;s<n.columns.length&&!n.order;s++)n.columns[s].sortable&&(n.order=[[s,"asc"]]);if(e.each(n.columns||[],function(t,e){e.defaultContent=e.defaultContent||""}),n.drawCallback=n.drawCallback||this._drawCallback.bind(this),n.searchDelay=n.searchDelay||700,this.dtOptions=n,this.$el.on("init.dt",function(t,i){var o=new e.fn.dataTable.Api(i).table();e(o.container()).find(".dataTables_filter input").unbind().bind("input",function(t){(this.value.length>=3||13==t.keyCode)&&o.search(this.value).draw(),""==this.value&&o.search("").draw()})}),!1!==n.stateSave&&(n.stateSave=!0,n.stateLoadCallback=n.stateLoadCallback||function(e,i){var n=t.CoreManager.getStorageController().getItem(o._storageKey);i(n?JSON.parse(n):n)},n.stateSaveCallback=n.stateSaveCallback||function(e,i){t.CoreManager.getStorageController().setItem(o._storageKey,JSON.stringify(i))}),n.buttons||this.options.defaultButtons){if(this._requires.push("datatables.net-buttons-bs"),this._requires.push("datatables.buttons.colVis"),this._requires.push("datatables.buttons.print"),this.options.defaultButtons&&(n.buttons=n.buttons||[],!1!==this.options.pageLengthButton&&n.buttons.push("pageLength"),!1!==this.options.colvisButton&&n.buttons.push({extend:"colvis",text:'<i class="fa fa-eye"></i>'}),!1!==this.options.printButton&&n.buttons.push({extend:"print",text:'<i class="fa fa-print"></i>',exportOptions:{columns:":visible"}}),!1!==this.options.exportButton&&n.buttons.push({className:"btn btn-default btn-download",text:'<i class="fa fa-download"></i>',action:o._exportData.bind(o)}),this.options.createNew&&"function"==typeof this.options.onCreate)){var r="btn btn-default btn-add";this.options.aclCreate&&"*"!==this.options.aclCreate&&e.each(this.options.aclCreate.split(" "),function(t,e){e&&(r=r+" req-role-"+e)}),n.buttons.push({className:r,text:'<i class="fa fa-plus"></i>',action:o.options.onCreate.bind(o)})}n.dom=n.dom||"<'row'<'col-sm-6'B><'col-sm-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-5'i><'col-sm-7'p>>"}return t.Utils.require(this._requires).then(function(){var t=o._requires.indexOf("moment");-1!==t&&(i=arguments[t]),o.dt=o.$el.DataTable(n)})},a.prototype._drawCallback=function(i){var o=this,n=new e.fn.dataTable.Api(i).table(),s=e(n.body());s.find("a.table-cmd-col").each(function(){var i=e(this),s=i.parents("tr"),r=e(s).hasClass("child")?e(s).prev():s,a=n.row(r).data();t.Utils.hasAccess(a.DT_RowData.getACL()).then(function(t){var e=t?o.options.iconButtonEdit:o.options.iconButtonView,n=t?o.options.classButtonEdit:o.options.classButtonView;i.addClass(n).html(e).show()})}),s.find(".btn").on("click",function(i){var s=e(i.currentTarget).data();if("function"==typeof o.options.onAction){var r=e(this).parents("tr"),a=e(r).hasClass("child")?e(r).prev():r,l=n.row(a).data();return o.options.onAction(s,l.DT_RowData,i.currentTarget),void i.preventDefault()}t.Router&&t.Router.lookup("data",s)&&(i.preventDefault(),t.Router.navigate(t.Router.lookup("data",s)))})},a.prototype._getColumn=function(o){var n=this,s={data:"objectId"===o.field?"id":o.field,type:o.type,sortable:void 0===o.sortable?-1!==["Number","Date","String","Boolean"].indexOf(o.type):o.sortable};return this.options.columns&&this.options.columns[o.field]?"function"==typeof this.options.columns[o.field]?this.options.columns[o.field](this,o):this.options.columns[o.field]:(o.targetClass&&(s.targetClass=o.targetClass),"objectId"===o.field?s.render=function(t,e,i,o){return'<a data-object-id="'+t+'" data-field-id="objectId" href="#" class="table-cmd-col '+n.options.classButtons+'" style="display:none"></a>'}:"Date"===o.type?(-1===n._requires.indexOf("moment")&&n._requires.push("moment"),s.render=function(t,e,s,r){return t&&void 0!==i&&i(t).isValid()?i(t).format(o.dateFormat||n.options.dateFormat||"lll"):t||'<i class="fa fa-calendar-o"></i>'}):"Pointer"===o.type?s.render=function(e){return e?e.className?'<a href="#" data-object-id="'+e.id+'" data-field-id="'+o.field+'" data-action="pointer" data-target-class="'+e.className+'" class="btn '+n.options.classButtons+' "><i class="fa fa-search"></i></a>'+("Files"===e.className?' <a href="'+t.serverURL+"/storage/"+t.applicationId+"/"+e.id+'" target="_blank"><i class="fa fa-download"></i></a>':""):e:""}:"Relation"===o.type?s.render=function(t){return t?'<a href="#"  data-object-id="'+(t.parent?t.parent.id:"")+'"  data-field-id="'+o.field+'" data-action="relation" data-target-class="'+(t.targetClassName||o.targetClass||o.className)+'"  class="'+n.options.classButtons+' btn-default"><i class="fa fa-search"></i> view ['+o.field+"] </a>":""}:"String"===o.type?s.render=function(t,i,o){return e("<div>"+(t||"")+"</div>").text().trunc(50,!0)}:"Object"===o.type?s.render=function(t){return t&&Object.keys(t).length?"[object]":""}:"Boolean"===o.type?s.render=function(t){return t?'<i class="fa fa-check-square-o"></i>':'<i class="fa fa-square-o"></i>'}:"File"===o.type?s.render=function(t){return(t=t&&t.toJSON?t.toJSON():t)?'<a href="'+t.url+'" target="_blank"><i class="fa fa-external-link"></i> '+(t.name?t.name.substr(t.name.indexOf("_")+1):"")+"</a>":""}:"Array"===o.type?s.render=function(t){return t?"[array]":"[]"}:"GeoPoint"===o.type?s.render=function(t){return t?"{geopoint}":"{geopoint:new}"}:"Number"===o.type&&(s.render=function(t){return e.isNumeric(t)?"function"==typeof t.format?t.format():t:""}),o.field&&s.sortable&&-1!==o.field.indexOf(".")&&(s.sortable=!1),s)},a.prototype._getColumns=function(){var t=this,i=[];return this.$("thead th").each(function(){var o,n=e(this).data();n.field&&((o=t._getColumn(n))&&i.push(o),t._colsData=t._colsData||{},t._colsData[n.field]=n)}),i},a.prototype.reload=function(){this.__qcache=null,this.dt.ajax.reload()},a.prototype.getSearchQuery=function(o){var n=this,s=new t.Query(this.options.className),r=[],a=[];return this.where&&(s._where=e.extend({},this.where)),e.each(this.dtOptions.columns,function(e,s){var l;if(s.targetClass&&-1!==s.mData.indexOf(".")&&-1===a.indexOf(s.mData.split(".")[0])&&a.push(s.mData.split(".")[0]),o&&s.data&&s.type)switch(s.type.toLowerCase()){case"pointer":case"string":s.data&&(-1===s.data.indexOf(".")?r.push(new t.Query(n.options.className).matches(s.data,new RegExp(o.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))):n._colsData[s.data]&&n._colsData[s.data].targetClass&&(l=s.data.split("."),r.push(new t.Query(n.options.className).matchesQuery(l[0],new t.Query(n._colsData[s.data].targetClass).matches(l[1],new RegExp(o.replace(/[-\[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))))));break;case"num":case"number":s.data&&!isNaN(parseFloat(o,10))?r.push(new t.Query(n.options.className).equalTo(s.data,parseFloat(o,10))):n._colsData[s.data]&&n._colsData[s.data].targetClass&&(l=s.data.split("."),r.push(new t.Query(n.options.className).matchesQuery(l[0],new t.Query(n._colsData[s.data].targetClass).equalTo(l[1],parseFloat(o,10)))));break;case"date":s.data&&void 0!==i&&i(o).isValid()&&r.push(new t.Query(n.options.className).equalTo(s.data,i(o).toDate()))}}),this.options.columnsOnly&&s.select(e.map(this.dtOptions.columns,function(t){return t.mData})),a.length&&s.include(a),r.length&&s._orQuery(r),Promise.resolve(s)},a.prototype.onError=function(e){t.Trace.captureException(e),"function"==typeof this.options.onError&&this.options.onError.call(this,e)},a.render=function(e,i){t.Utils.render("default/templates/controls/dataset-grid",i).then(function(t){return e.html(t),new a(e.find("table"),i)})},a.prototype.hide=function(){this.trigger("hide"),e(this.dt.table().container()).hide()},a.prototype.show=function(){this.trigger("show"),e(this.dt.table().container()).show()},t.UI.DataTable=a,t.UI.DataTable.defaults=e.extend({},t.UI.Control.defaults,{defaultButtons:!0,classButtons:"btn btn-xs",classButtonEdit:"btn-success",classButtonView:"btn-default",iconButtonEdit:'<i class="fa fa-pencil-square-o"></i>',iconButtonView:'<i class="fa fa-search"></i>'}),l.prototype=Object.create(t.UI.Control.prototype),l.prototype.constructor=l,l.prototype.initialize=function(){var i=this;return t.Utils.require(["export_renderers","c3_renderers","css!"+CDN_ROOT+"/vendor/pivottable/pivot.min.css","css!"+CDN_ROOT+"/vendor/c3/c3.css"]).then(function(){return e.extend(e.pivotUtilities.renderers,e.pivotUtilities.c3_renderers,e.pivotUtilities.export_renderers),t.UI.Control.prototype.initialize.call(i)})},l.prototype.render=function(){var i=this;return this.getData().then(function(o){var n="box.pivot."+t.applicationId+"."+(i.options.className||"cls"),s=JSON.parse(t.Storage.getItem(n)||"false")||i.options.pivot||{},r=i.$(i.options.selectContainer);return s.onRefresh=s.onRefresh||i._onRefresh.bind(i),r.length||(r=i.$el),e(r).pivotUI(o,s,!0),t.UI.Control.prototype.render.call(this)})},l.prototype.getData=function(){var e=this,i={};return"function"==typeof this.options.getData?this.options.getData.call(this):this.options.className&&this.options.pipeline?(this.options.useMasterKey&&t.masterKey&&(i={useMasterKey:!0}),t.Cloud.run("data_aggregate",{className:this.options.className,pipeline:this.options.pipeline},i).then(function(t){return"function"==typeof e.options.processData?e.options.processData.call(e,t):e._processData(t)})):Promise.resolve([])},l.prototype._onRefresh=function(e){var i="box.pivot."+t.applicationId+"."+(this.options.className||"cls"),o=JSON.parse(JSON.stringify(e));!1!==this.options.noStatus&&(delete o.aggregators,delete o.renderers,delete o.rendererOptions,delete o.localeStrings,t.Storage.setItem(i,JSON.stringify(o)))},l.prototype._processData=function(e){var i=t._.map(e,function(e){var i={};return t._.each(e,function(o,n){"_id"===n?t._.each(e[n],function(t,e){i[e]=t}):i[n]=o}),i});return Promise.resolve(i)},t.UI.PivotTable=l,t.UI.PivotTable.defaults={},c.prototype=Object.create(o.prototype),c.prototype.constructor=c,c.prototype.initialize=function(){var o=this,n=t.UI.Control.prototype.initialize.call(this);return!this.options.readOnly&&this.options.removeButtonClass?this.$(this.options.removeButtonClass).click(function(t){t.preventDefault(),e(this).hasClass("disabled")||"function"==typeof o.options.onRemove&&o.options.onRemove(o)}):this.$(this.options.removeButtonClass).hide(),this.options.cancelButtonClass&&this.$(this.options.cancelButtonClass).click(function(t){t.preventDefault(),o.wire().then(function(){"function"==typeof o.options.onCancel&&o.options.onCancel(o)})}),!this.options.readOnly&&this.options.createButtonClass?this.$(this.options.createButtonClass).click(function(i){var n=e(i.currentTarget);i.preventDefault(),e(this).hasClass("disabled")||(n.hide(),o.update().then(function(){var t=o.options.useMasterKey?{useMasterKey:!0}:void 0;return o.trigger("saving"),o.model.save({},t)}).then(function(){return o._uploadFiles()}).then(function(){"function"==typeof o.options.onUpdated&&o.options.onUpdated(o),o.trigger("saved"),t.Utils.require("notification").then(function(){e.notify({message:"Updated !",icon:"fa fa-info-circle"},{type:"info"})}),!o.model&&o.model.id&&o._useEditorLock&&t.Socket.hasClient()&&(o._timerSync={className:o.model.className,objectId:o.model.id},o._lockSync()),n.show()}).catch(function(e){n.show(),"function"==typeof o.options.onError&&o.options.onError(e),e.validate||t.Utils.require("notification").then(function(){t.Trace.captureException(e)})}))}):this.$(this.options.createButtonClass).hide(),this.$(".input-group-btn .btn").click(function(i){var n=e(i.currentTarget).parents(".input-group"),s=n.find("input"),r=s.data("bm-field");r&&r.split("$")[0]===o.options.className&&(i.preventDefault(),n.removeClass("input-group").find("button").hide(),t.Utils.require(["summernote","css!"+CDN_ROOT+"/vendor/summernote/summernote"]).then(function(){o.wireSummernote(s),s.summernote("code",s.val())}))}),this.$("select[data-field-target]").each(function(){var i=e(this).data("bm-field"),n={};o.options.useMasterKey&&(n={useMasterKey:!0}),i&&i.split("$")[0]===o.options.className&&(i=i.split("$")[1],o.options.selects&&o.options.selects[i]&&(n=e.extend(n,o.options.selects[i])),o.selects[i]=new t.UI.Select(this,n))}),this.$('input[data-field-type="Number"]').each(function(i,n){var s=e(this).data("bm-field");s&&s.split("$")[0]===o.options.className&&t.Utils.inputDigitsOnly(e(this))}),this.$('[data-field-type="Date"]').length&&(n=n.then(function(){return t.Utils.require(["moment","bootstrap-datetimepiker"]).then(function(t){i=t,o.$(".form-group .input-group.date").datetimepicker({format:o.options.dateFormat})})})),n=n.then(function(){return o.$(".editor-lock .users-open-close").length&&t.Socket.hasClient()?(o._useEditorLock=!0,o.$(".editor-lock .users-open-close").click(function(t){t.preventDefault(),e(this).parent().toggleClass("open")}),t.Socket.client().then(function(t){t.on("edit",function(t){o._showLocks(t)})})):Promise.resolve()})},c.prototype.wire=function(o,n){var s=this,r=Promise.resolve(),a=this.options.bindFilter||"[data-bm-field]";return o&&o.className&&o.className!==this.options.className?r:(this.model=o,this.__files=[],this.model&&this.model.id?(this.readOnly=this.options.readOnly,this.readOnly?(this.$(".readonly-field").show(),this.$(this.options.removeButtonClass).addClass("disabled"),this.$(this.options.createButtonClass).addClass("disabled")):(this.$(this.options.createButtonClass).html(this.options.updateButtonText),this.$(this.options.removeButtonClass).removeClass("disabled"),this.$(this.options.createButtonClass).removeClass("disabled"))):(this.readOnly=!1,this.$(".readonly-field").hide(),this.$(this.options.removeButtonClass).addClass("disabled"),this.$(this.options.createButtonClass).html(this.options.createButtonText),this.$(this.options.createButtonClass).removeClass("disabled")),this.$(a).each(function(){var n=this;r=r.then(function(){return function o(n,s,r){var a,l=e(this).data(),c=l.bmBind,d=l.bmDefault||"",u=[],p="change",h=n.options.bindFilter||"[data-bm-field]",f=l.bmField,m=Promise.resolve();if(l.bmUpdateOnly||!f||-1===f.indexOf("$"))return Promise.resolve();var y=this.nodeName;f=f.split("$");if(f[0]!==n.options.className)return Promise.resolve();f=f[1];c||("IMG"===y?(c="prop",u.push("src")):"INPUT"===y&&"checkbox"===this.type?(c="prop",u.push("checked")):c="INPUT"===y||"SELECT"===y||"TEXTAREA"===y?"val":"html");a=r||(s?s.get(f):d);a&&a.id&&a.className&&(a=a.id);if("string"==typeof a&&("String"===l.fieldType||0===c.indexOf("summernote;"))){if(a.trim().match(/^<[a-z][\s\S]*>/i)&&($input=e(this),$input.parents(".input-group").removeClass("input-group").find("button").hide(),!e(this).data("summernote")))return t.Utils.require(["summernote","css!/vendor/summernote/summernote"]).then(function(){n.wireSummernote($input),$input.summernote("code",a),p="summernote.change",$input.off(p).on(p,function(){var t=e(this).val();"function"==typeof n.trigger&&n.trigger("change",f,t),n.$(h+'[data-bm-field="'+e(this).data("bm-field")+'"]').not(this).each(function(){o.call(this,n,s,t)})})});e(this).data("summernote")&&(c="summernote;code",p="summernote.change")}if("Files"===l.fieldTarget)return n.__files.push(this),m;"Date"===l.fieldType&&(a=a&&void 0!==i&&i(a).isValid()?i(a).format(n.options.dateFormat):a);"Object"===l.fieldType&&(a=a?JSON.stringify(a):a);n.selects&&n.selects[f]?n.selects[f].val(a):("Pointer"===l.fieldType&&(a=s&&"function"==typeof s.get&&s.get(f)&&"function"==typeof s.get(f).get?s.get(f).get(l.searchFor||"name"):a),-1!==c.indexOf(";")&&(c=c.split(";"),u.push(c[1]),c=c[0]),u.push(a),e.fn[c].apply(e(this),u),"INPUT"===y&&"checkbox"===this.type&&e(this).trigger("change"));void 0===l.bmWithNoChange&&e(this).off(p).on(p,function(){var t=e(this).val();"function"==typeof n.trigger&&n.trigger("change",f,t),n.$(h+'[data-bm-field="'+e(this).data("bm-field")+'"]').not(this).each(function(){o.call(this,n,s,t)})});return m}.call(n,s,o)})}),(r=r.then(function(){var i=[],n=Promise.resolve();if(s.$(".file-placeholder .file-list").empty(),s.__files.length){if(o&&(e.each(s.__files,function(t,n){var s=e(n).data().bmField.split("$")[1],r=o.get(s);r&&i.push(r.id)}),i.length)){var r=new t.Query("Files");r.containedIn("objectId",i),n=r.find()}n=n.then(function(t){return Promise.all(e.map(s.__files,function(i){var n,r,a,l=e(i).data(),c=l.bmField.split("$")[1];if(o&&(r=o.get(c)))for(a=0;!n&&a<t.length;a++)t[a].id===r.id&&(n=t[a].toJSON());return s.files[l.bmField]||(s.files[l.bmField]={el:i,role:c}),s.renderImage(n,e(i))}))})}return n})).then(function(){return Promise.all(e.map(s.childrens||[],function(t){return t.wire(o,!0)}))}).then(function(){s.trigger("wired"),s.model&&s.model.id&&s._useEditorLock&&t.Socket.hasClient()&&(s._timerSync={className:s.model.className,objectId:s.model.id},s._lockSync())}))},c.prototype._lockSync=function(){var i=this;if(!this._timerSync)return i._showLocks();Promise.resolve().then(function(){return i.model&&!i.model.isNew()&&e.contains(document,i.$el[0])||(i._timerSync.leave=!0),t.Socket.client().then(function(t){return new Promise(function(e,o){t.emit("edit",i._timerSync,function(t){return i._timerSync.leave&&delete i._timerSync,i._showLocks(t).then(e,o)})})})}).then(function(){setTimeout(i._lockSync.bind(i),i.options.editSyncTimer)},function(){setTimeout(this._lockSync.bind(this),i.options.editSyncTimer)})},c.prototype._showLocks=function(t){var i=[],o="";return t&&this.model&&this.model.id===t.object.objectId?(e.each(t,function(t,e){"object"!==t&&(i.push(e),o+='<li><i class="fa fa-user"></i> {username}</li>'.format(e.editor.user))}),i.length>1?(this.$(".editor-lock").show(),this.$(".editor-lock .lock-list-body ul").html(o)):this.$(".editor-lock").hide(),Promise.resolve()):(this.$(".editor-lock").hide(),Promise.resolve())},c.prototype.addChilds=function(t){this.childrens=this.childrens||[],t.parent=this,this.childrens.push(t)},c.prototype._uploadFiles=function(){var i=this;return Promise.all(e.map(this.files,function(o){return e(o.el).val()?new Promise(function(n,s){var r,a,l=e(o.el).parents(".input-file"),c=(l.find('input[type="file"]')||[])[0];if(c&&c.files&&c.files.length)return r=c.files[0],l.find(".file-edit").hide(),l.find(".fileinput-button").hide(),l.find(".progress").show(),a={role:o.role,className:i.options.className,name:r.name,contentType:r.type||"application/octet-stream"},i.model&&i.model.id&&(a.objectId=i.model.id),t.Cloud.run("createPresignedPost",a).then(function(a){var c,d=new FormData;t.$.each(a.fields,function(t,e){d.append(t,e)}),d.append("file",r),a.file&&(a.file.className=a.file.className||"Files",c=t.Object.fromJSON(a.file)),t.$.ajax({url:a.url,type:"POST",data:d,processData:!1,contentType:!1,success:function(e){return Promise.resolve().then(function(){var e=i.options.useMasterKey?{useMasterKey:!0}:void 0,n=[];if(a.file)return r.size&&c.set("size",r.size),r.lastModifiedDate&&c.set("lastModified",r.lastModifiedDate),c.set("key",a.fields.key),"public-read"===a.fields.ACL&&c.set("url",a.url+"/"+a.fields.key),n.push(c),i.model&&(i.model.set(o.role,c),n.push(i.model)),t.Object.saveAll(n,e).then(function(){return c})}).then(function(e){t.Object.fromJSON(a.file);l.find(".file-edit").show(),l.find(".file-edit").val(""),l.find(".fileinput-button").show(),l.find(".progress").hide(),l.find('input[type="file"]').val(""),i.renderImage(e?e.toJSON():null,l).then(n,s)}).then(n,s)},error:function(){alert("Failed"),l.find(".progress").hide(),l.find(".file-edit").show(),l.find(".fileinput-button").show(),s()},xhr:function(){return myXhr=e.ajaxSettings.xhr(),myXhr.upload?myXhr.upload.addEventListener("progress",function(t){if(t.lengthComputable){var e=Math.floor(t.loaded/t.total*100);l.find(".progress span").html(e<95?e+"%":"sending to cloud.."),l.find(".progress .progress-bar").css({width:e+"%"})}},!1):(l.find(".progress").hide(),console.log("Uploadress is not supported.")),myXhr}})},function(){l.find(".progress").hide(),l.find(".file-edit").show(),l.find(".fileinput-button").show(),s(message)})}):Promise.resolve()})).then(function(){i.options.useMasterKey}).catch(function(e){t.Utils.require("notification").then(function(){t.Trace.captureException(e)}),"function"==typeof i.options.onError&&i.options.onError(e)})},c.prototype.renderImage=function(e,i){var o=this,n=Promise.resolve();if(e){var s=e.url?e.url:t.serverURL+"/storage/"+t.applicationId+"/"+e.objectId,r=i.parents(".file-placeholder").find(".file-list");r.length||(i.parents(".file-placeholder").prepend('<ul class="file-list"></ul>'),r=i.parents(".file-placeholder").find(".file-list")),r.empty(),r.append(o.options.imageFormat.format({display:e.contentType&&0===e.contentType.indexOf("image/")?'<img src="'+s+'">':'<i class="fa fa-file"></i>',name:e.name,id:e.objectId,url:s,size:e.size.toByteSize()})),r.find("a.text-danger:last").click(function(n){var s=i.data();n.preventDefault(),t.Utils.require("bootstrap-dialog").then(function(n){n.confirm({title:"Atenție",type:n.TYPE_WARNING,message:"<i class='fa fa-trash-o text-danger'></i> Remove <i>"+e.name+"</i> ?",closable:!0,btnCancelLabel:'<i class="fa fa-ban"></i> Cancel !',btnOKLabel:'<i class="fa fa-trash-o"></i> Delete!',btnOKClass:"btn-danger",callback:function(e){if(e){var n,r=s.bmField.split("$")[1];return o.options.useMasterKey&&{useMasterKey:!0},n=o.model.get(r),o.model.set(r,null),n&&n.set("purged",!0),t.Object.saveAll([n,o.model]).then(function(){o.renderImage(null,i)})}}})})})}else i.parents(".file-placeholder").find(".file-list").remove();return n},c.prototype.validate=function(){var i,o=this,n=(this.options.bindFilter||"[data-bm-field]")+"[data-bm-required]",s=Promise.resolve();return this.$(n).each(function(){var o=e(this).data(),n=o.bmBind,r=[];if(!n){var a=this.nodeName;"IMG"===a?(n="prop",r.push("src")):"INPUT"===a&&"checkbox"===this.type?(n="prop",r.push("checked")):n="INPUT"===a||"SELECT"===a||"TEXTAREA"===a?"val":"html"}e(this).data("summernote")&&(n="summernote;code"),-1!==n.indexOf(";")&&(n=n.split(";"),r.push(n[1]),n=n[0]),e.fn[n].apply(e(this),r)||(i=i||{field:o.bmField,validate:!0,message:o.bmRequiredError||o.bmField.split("$").join(" ")+" is required"},s=s.then(function(){return t.Utils.require("notification").then(function(){e.notify({message:o.bmRequiredError||o.bmField.split("$").join(" ")+" is required",icon:"fa fa-exclamation-circle"},{type:"danger",timer:5e3})})}))}),i&&(s=s.then(function(){return Promise.reject(i)})),s.then(function(){return Promise.all(e.map(o.childrens||[],function(t){return t.validate()}))})},c.prototype.wireSummernote=function(i,o){var n=this;i.data("summernote")||(n.options.summernote=n.options.summernote||{},t._.defaults(n.options.summernote,{height:"300px",focus:!1,tabsize:2,dialogsInBody:!0,callbacks:{onChange:function(t){e(this).val(t)},onImageUpload:function(o){var s=e(this).data("summernote").modules.editor,r=n.options.useMasterKey?{useMasterKey:!0}:void 0,a=Promise.resolve(),l=n.options.fileRole||!!i.data("bm-field")&&i.data("bm-field").split("$")[1]||"attachment",c=o[0];return n.model&&n.model.isNew()&&(a=a.then(function(){return a.save({},r)})),a.then(function(){var o;(n.options.fileRole||i.data("bm-field"))&&i.data("bm-field").split("$")[1];return i.parent().find(".summer-progress").show(),o={role:l,className:n.options.className,name:c.name,inline:!0,contentType:c.type||"application/octet-stream"},n.model&&n.model.id&&(o.objectId=n.model.id),t.Cloud.run("createPresignedPost",o).then(function(o){var n,a=new FormData;return t.$.each(o.fields,function(t,e){a.append(t,e)}),a.append("file",c),o.file&&(o.file.className=o.file.className||"Files",n=t.Object.fromJSON(o.file)),new Promise(function(l,d){t.$.ajax({url:o.url,type:"POST",data:a,processData:!1,contentType:!1,success:function(e){return Promise.resolve().then(function(){if(o.file)return c.size&&n.set("size",c.size),c.lastModifiedDate&&n.set("lastModified",c.lastModifiedDate),n.set("key",o.fields.key),"public-read"===o.fields.ACL&&n.set("url",o.url+"/"+o.fields.key),n.save({},r)}).then(function(e){s.restoreRange(),e&&s.insertImage(t.serverURL+"/storage/"+t.applicationId+"/"+e.id,e.get("name")),i.parent().find(".summer-progress").hide(),l()}).then(l,d)},error:function(){i.parent().find(".summer-progress").hide(),d()},xhr:function(){return myXhr=e.ajaxSettings.xhr(),myXhr.upload?myXhr.upload.addEventListener("progress",function(t){if(t.lengthComputable){var e=Math.floor(t.loaded/t.total*100);i.parent().find(".summer-progress span").html(e<95?e+"%":"sending to cloud.."),i.parent().find(".summer-progress .progress-bar").css({width:e+"%"})}},!1):(i.parent().find(".summer-progress").hide(),console.log("Uploadress is not supported.")),myXhr}})})},function(t){i.parent().find(".summer-progress").hide()})})}}}),i.summernote(n.options.summernote),i.parent().css("position","relative"),i.parent().append(n.options.progressBar))},c.prototype.update=function(){var o,n=this,s=this.options.bindFilter||"[data-bm-field]";return this.model||this.options.className?(o=this.validate(),this.model||(this.$('input[name="objectId"]').val()?this.model=new t.Object.fromJSON({className:this.options.className,objectId:this.$('input[name="objectId"]').val()}):this.model=new t.Object(this.options.className)),this.$(s).each(function(){var s,r,a=e(this).data(),l=a.bmBind,c=[];if(!(a.bmDisplayOnly||"Files"===a.fieldTarget&&"Pointer"===a.fieldType)&&(s=(s=-1===a.bmField.indexOf(";")?a.bmField:a.bmField.split(";")).split("$"))[0]===n.options.className){if(s=s[1],!l){var d=this.nodeName;if(-1!==(n.options.readOnlyBind||["P","DIV"]).indexOf(d))return;"IMG"===d?(l="prop",c.push("src")):"INPUT"===d&&"checkbox"===this.type?(l="prop",c.push("checked")):l="INPUT"===d||"SELECT"===d||"TEXTAREA"===d?"val":"html"}if(e(this).data("summernote")&&(l="summernote;code"),-1!==l.indexOf(";")&&(l=l.split(";"),c.push(l[1]),l=l[0]),r=e.fn[l].apply(e(this),c),"Number"===a.fieldType){var u=parseFloat(r);r=isNaN(u)?null:u}else"Boolean"===a.fieldType&&"string"==typeof r?r="true"===r.toLowerCase():"Pointer"===a.fieldType?r=r?t.Object.fromJSON({className:a.fieldTarget,objectId:r}):null:"String"===a.fieldType?r=r.trim():"Date"===a.fieldType?r=r&&void 0!==i&&i(r,n.options.dateFormat).isValid()?i(r,n.options.dateFormat).toDate():null:"Object"===a.fieldType&&(r=r?JSON.parse(r):null);"Relation"===a.fieldType?n.selects[s]&&(o=o.then(function(){return n.selects[s].syncRelation(n.model)})):n.model.set(s,r)}}),o.then(function(){return Promise.all(e.each(n.childrens||[],function(t){return t.update()}))})):Promise.reject(new Error("Invalid binding"))},c.prototype.destroy=function(){var i=this,o=this.childrens||[];return e.each(this.selects,function(t,e){"function"==typeof e.destroy&&o.push(e.destroy())}),e.when.apply(e,o).then(function(){return t.UI.Control.prototype.destroy.call(i)})},t.UI.Editor=c,t.UI.Editor.defaults=e.extend({},t.UI.Control.defaults,{cancelButtonClass:"footer .btn-default",createButtonClass:"footer .btn-success",removeButtonClass:"footer .btn-danger",createButtonText:'<i class="fa fa-plus"></i> Create',updateButtonText:'<i class="fa fa-floppy-o"></i> Update',imageFormat:'<li data-object-id="{id}"><div class="well well-sm"><span>{display}</span><br><strong>{name}</strong><br>{size}<br><a href="{url}" target="_blank"><i class="fa fa-download"></i> Download</a>  | <a href="#" data-file-id="{id}" class="text-danger"><i class="fa fa-times"></i> Remove</a></div></li>',progressBar:'<div class="summer-progress" style="display:none"><div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;"><span>0%</span></div></div>',bindFilter:"[data-bm-field]",dateFormat:"DD-MM-YYYY",editSyncTimer:3e4}),d.prototype=Object.create(o.prototype),d.prototype.constructor=d,d.prototype.initialize=function(){var i=this,o=this.$el.prop("id"),n={onAction:this.onAction.bind(this),onUpdated:function(){i.grid.reload(),i.trigger("saved")},onCreate:function(){var e=new t.Object(i.options.className);i.wire(e)},onCancel:function(){i.grid.show(),i.editor.hide(),i.trigger("canceled")}},s=e.extend({},n,this.options);return this.grid=this.options.grid||new a(this.$(this.options.gridId?this.options.gridId:o?"#"+o+"-table":"table.box-table"),s),this.editor=this.options.editor||new c(this.$(this.options.editorId?this.options.editorId:o?"#"+o+"-form":"form.box-editor"),s),t._.defaults(this.editor.options,n),Promise.all([this.editor.p||Promise.resolve(),this.grid.p||Promise.resolve()]).then(function(){return t.UI.Control.prototype.initialize.call(i)})},d.prototype.onAction=function(t,e,i){t.fieldId&&t.objectId&&this.wire(e)},d.prototype.wire=function(t){this.grid.hide(),this.editor.$el.removeClass("hidden").show(),this.editor.wire(t),this.trigger("wired")},d.prototype.showGrid=function(t){this.editor.hide(),this.grid.show(),t&&this.grid.reload()},d.prototype.destroy=function(){var i=this,o=[];return this.editor&&"function"==typeof this.editor.destroy&&o.push(this.editor.destroy()),this.grid&&"function"==typeof this.grid.destroy&&o.push(this.grid.destroy()),e.when.apply(e,o).then(function(){return t.UI.Control.prototype.destroy.call(i)})},t.UI.DataSet=d,t.UI.DataSet.defaults={}});