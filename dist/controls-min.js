!function(t,e){if("function"==typeof define&&define.amd)define(["Box","module","require"],e);else{e(Box)}}(0,function(t,e,i){var o,n,s=t.$,r=void 0===e.config().loadCss||e.config().loadCss,a=void 0!==e.config().i18n&&e.config().i18n,l=void 0!==e.config().bs4&&e.config().bs4;function c(t){return a?(n=n||i("i18next")).t(t):t}function d(e,i){var o=this;this.cid=t._.uniqueId("view"),this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.Control.defaults,this.$el.data(),i||{}),this.p=this.p||Promise.resolve(),this.p.then(function(){var t;if(!o.options.domLink)return Promise.resolve();(t=o.$el.data(o.options.domLink))&&"function"==typeof t.destroy&&(t.destroy(),o.options[o.options.domLink]&&(o.options[o.options.domLink]=null)),o.$el.data(o.options.domLink,o)}).then(function(){return o.initialize()})}"undefined"==typeof CDN_ROOT&&(CDN_ROOT=""),t.UI=t.UI||{};var p=/^(\S+)\s*(.*)$/;function u(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.View.defaults,this.$el.data(),i||{}),this.$container=this.$el.find(this.options.selectContainer),this.$messages=this.$el.find(this.options.messagesContainer),this.childrens=[],t.UI.Control.call(this,e,this.options)}function h(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.Select.defaults,this.$el.data(),i||{}),this.options.className=this.options.className||this.$el.data("field-target"),this.options.field=this.options.field||this.$el.data("bm-field").split("$")[1],this.options.parentClass=this.options.parentClass||this.$el.data("bm-field").split("$")[0],this.options.searchFor=this.options.searchFor||s(e).data("search-for")||t.UI.Select.defaults.mapSearch[this.options.className]||"name",this.options.display=this.options.display||s(e).data("display"),this.options.relation=this.options.relation||"Relation"===this.$el.data("field-type"),this.options.preload=this.options.preload||!!this.$el.data("preload"),this.options.withData=this.options.withData||!!this.$el.data("with-data"),this.options.order=this.options.order||this.$el.data("order"),t.UI.Control.call(this,e,s.extend({},t.UI.Select.defaults,i||{}))}function f(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.DataTable.defaults,this.$el.data(),i||{}),this.options.className=this.options.className||this.$el.data("class-name"),this.queryOptions=this.options.query||{},this.where=this.options.where||{},this._include=this.options.include||this.$el.data("query-include"),this._storageKey=this._storageKey||this.$el.attr("id")||"DataSet:"+this.options.className+"#"+(this.$el.parents(".jarviswidget").eq(0).attr("id")||"")+":"+(t.User.current()?t.User.current().id:"*"),t.UI.Control.call(this,e,s.extend({},t.UI.DataTable.defaults,i||{}))}function m(e,i){this.$el=s(e),this.options=s.extend({},t.UI.PivotTable.defaults,i||{}),t.UI.Control.call(this,e,this.options)}function y(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.Editor.defaults,s(this.$el).data(),i||{}),this.readOnly=!0,this.selects=this.selects||{},this.files=this.files||{},t.UI.Control.call(this,e)}function g(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.DataSet.defaults,this.$el.data(),i||{}),this.options.className=this.options.className||this.$el.data("class-name"),void 0===this.options.createNew&&(this.options.createNew=!!this.$el.data("acl-create")),t.UI.Control.call(this,e)}s.extend(d.prototype,t.Events,{$:function(t){return this.$el.find(t)},destroy:function(){return this.trigger("destroy"),this._removeElement(),this.stopListening(),this.p},_removeElement:function(){this.$el.remove()},initialize:function(){var e=this,i=Array.prototype.slice.call(arguments);return this.options.events&&this.delegateEvents(this.options.events),this.options.controller&&(this.p=this.p.then(function(){return t.Utils.require(e.options.controller.src||e.options.controller).then(function(t){"function"==typeof t?e.controller=new t(e):t&&"function"==typeof t.getController?e.controller=t.getController(e):t&&"function"==typeof t.init&&t.init.call(e,e.$el)})})),this.p.then(function(){return e.trigger("initialized"),e.render.apply(e,i)})},render:function(){return this.trigger("rendered"),this.p},show:function(){this.trigger("show"),this.$el.show()},hide:function(){this.trigger("hide"),this.$el.hide()},delegateEvents:function(e){if(!(e=e||(e=t._.result(this,"events"))))return this;for(var i in this.undelegateEvents(),e){var o=e[i];if(t._.isFunction(o)||(o=this[o]),o){var n=i.match(p);this.delegate(n[1],n[2],t._.bind(o,this))}}return this},delegate:function(t,e,i){return this.$el.on(t+".delegateEvents"+this.cid,e,i),this.on(t,i),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this.off(),this},undelegate:function(t,e,i){return this.$el.off(t+".delegateEvents"+this.cid,e,i),this.off(t,i),this},_setAttributes:function(t){this.$el.attr(t)}}),d.prototype.constructor=d,t.UI.Control=d,t.UI.Control.defaults={domLink:"box.control",constructorClass:"box.constructor"},u.prototype=Object.create(d.prototype),u.prototype.constructor=u,u.prototype.initialize=function(){var e=this;return t.UI.Control.prototype.initialize.call(this).then(function(){return e.loadChildrens()})},u.prototype.showMessage=function(t){return this.$messages.html(t)},u.prototype.cleanChildrens=function(){var t,e=this,i=[],o=s.grep(this.childrens||[],function(t){return"function"==typeof t.destroy});for(t=0;t<o.length;t++)i.push(o[t].destroy());return s.when.apply(s,i).then(function(){for(var t,i=(e.childrens||[]).length;i--;)"function"==typeof(t=e.childrens.pop()).destroy&&t.destroy(),delete t;return e.childrens=[],Promise.resolve()})},u.prototype.loadChildrens=function(e){var i=[],o=this;return this.p=this.p.then(function(){return o.$container.find(o.options.childControls).each(function(n,r){var a,l,c=s(r).data("controller");if("function"==typeof o.options.childConstructor)return l=new o.options.childConstructor(r,e),o.childrens.push(l),void(l.p&&i.push(l.p));c&&(a=t.Utils.require(c).then(function(t){if(t&&"function"==typeof t.init)return t.init(r,o,e)}).then(function(){var t=s(r).data(o.options.domLink);t&&o.childrens.push(t)}).catch(function(e){t.Trace.captureException(e)}),i.push(a))}),Promise.all(i)}),this.p},u.prototype.load=function(e,i){var o=this;return i&&(e=e+"?"+t.Utils.querystring.stringify(i)),s.ajax({type:"GET",url:e,dataType:"html",beforeSend:function(e){o.showMessage(t.UI.View.defaults.loadingHtml),o.$container.css({opacity:"0.0"})}}).then(function(t){return o.cleanChildrens().then(function(){return o.$messages.hide(),o.$container.html(t).delay(50).animate({opacity:"1.0"},300),o.loadChildrens(i)})},function(i,n,s){o.showMessage(t.UI.View.defaults.errorHtml.format({url:e,status:i.status,err:s})),o.$container.animate({opacity:"1.0"},300)})},u.prototype.destroy=function(){var e=this;return this.cleanChildrens().then(function(){return t.UI.Control.prototype.destroy.call(e)})},t.UI.View=u,t.UI.View.defaults=s.extend({},t.UI.Control.defaults,{loadingHtml:'<h1 class="ajax-loading-animation"><i class="fa fa-cog fa-spin"></i> Loading...</h1>',errorHtml:'<h4 class="ajax-loading-error"><i class="fa fa-warning txt-color-orangeDark"></i> Error requesting <span class="txt-color-red">{url}</span>: {status} <span style="text-transform: capitalize;"> {err}</span></h4>',selectContainer:"box-content-container",messagesContainer:"box-messages-container",childControls:"[data-controller]"}),h.prototype=Object.create(d.prototype),h.prototype.constructor=h,h.prototype.initialize=function(){var e=this;return t.UI.Control.prototype.initialize.call(this).then(function(){return new Promise(function(i,o){var n=Promise.resolve(),r=e.options;return e.query?i():(this.__initial=[],e.query=r.query||new t.Query(r.className),r.display&&-1!==r.display.indexOf(".")&&r.display.split(";").forEach(function(t){var i=t.split(".");i.length>1&&e.query.include(i[0])}),r.order&&(e.query._order=r.order.split(",")),r.include&&e.query.include(r.include),s.fn.select2||(n=t.Utils.require(["select2"])),n.then(function(){var t={};return void 0!==r.useMasterKey&&(t.useMasterKey=r.useMasterKey),r.preload?e.query.find(t).then(function(t){var i=s.map(t,function(t){return'<option value="'+encodeURI(t.id)+'">'+(e.options.display||e.options.searchFor).split(",").map(function(e){return t.get(e)||""}).join(", ")+"</option>"}).join("");e.$el.html(i),e.$el.select2(s.extend({width:r.relation?"100%":r.width,allowClear:!e.options.bmRequired,placeholder:e.options.placeholder||"Select "+e.options.className},r)),e.$el.on("select2:select",function(){e.$el.data("select2").trigger("selection:update",{data:s(this).val()?s(this).select2("data"):[]})}),e.options.bmRequired||e.$el.on("select2:unselect",function(t){e.$el.data("select2").trigger("selection:update",{data:[]})})}):r.withData?(e.$el.select2(s.extend({width:r.relation?"100%":r.width,allowClear:!e.options.bmRequired,placeholder:e.options.placeholder||"Select "+e.options.className},r)),e.$el.on("select2:select",function(){e.$el.data("select2").trigger("selection:update",{data:s(this).val()?s(this).select2("data"):[]})}),void(e.options.bmRequired||e.$el.on("select2:unselect",function(t){e.$el.data("select2").trigger("selection:update",{data:[]})}))):(e.$el.select2(s.extend({width:r.relation?"100%":r.width,minimumInputLength:e.options.minimumInputLength||3,allowClear:!e.options.bmRequired,placeholder:e.options.placeholder||"Select "+e.options.className,ajax:{delay:e.options.delay||250,transport:e.options.transport||function(i,o,n){e.options.searchFor.split(",").forEach(function(t){e.query.matches(t,new RegExp(i.data.q.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))}),e.query.find(t).then(o,n)},processResults:e.options.processResults||function(t,i){var o=(e.options.display||e.options.searchFor).split(",");return{results:s.map(t,function(t){return{id:t.id,text:o.map(function(e){var i=e.split("."),o=e,n=t;return i.length>1&&(n=t.get(i[0]),o=i[1]),n.get(o)||""}).join(", ")}})}}}},r)),void(e.options.bmRequired||e.$el.on("select2:unselect",function(t){e.$el.empty()})))}).then(i,o))})})},h.prototype.val=function(e,i){var o=this;return this.options.preload||this.options.withData?o.$el.val(e).trigger("change"):this.p=this.p.then(function(){var n,r=i||new t.Query(o.options.className);return o.$el.empty().trigger("change"),e?(o.options.relation&&!i?r=e.parent.relation(o.options.field).query():"string"==typeof e&&r.equalTo("objectId",e),o.options.useMasterKey&&(n={useMasterKey:!0}),r.find(n).then(function(t){o.__initial=t,o.$el.html(s.map(t,function(t){return o.options.relation,'<option value="{id}" selected="selected">{text}</option>'.format({id:t.id,text:t.get(o.options.searchFor)})}).join("")).trigger("change")})):Promise.resolve()}),this.p},h.prototype.syncRelation=function(e){var i=this;return this.p=this.p.then(function(){var o=i.$el.val();if(!i.options.relation||!e)return Promise.resolve();s.each(i.__initial,function(t,n){-1===o.indexOf(n.id)&&e.relation(i.options.field).remove(n)}),s.each(o,function(o,n){s.grep(i.__initial,function(t){return t.id===n}).length||e.relation(i.options.field).add(t.Object.fromJSON({className:i.options.className,objectId:n}))})}),this.p},h.prototype.destroy=function(){return this.$el.select2("destroy"),t.UI.Control.prototype.destroy.call(this)},t.UI.Select=h,t.UI.Select.defaults=s.extend({},t.UI.Control.defaults,{width:"250px",mapSearch:{_User:"username",Files:"fileName"}}),f.prototype=Object.create(d.prototype),f.prototype.constructor=f,f.prototype._exportData=function(e,i,o,n){i.settings()[0].aoColumns;var r=i.columns(":visible")[0].map(function(t){return i.settings()[0].aoColumns[t].field});t.CoreManager.getRESTController().request("POST","tasks/create",{query:this.__qcache,className:this.options.className,items:r,title:"Export "+this.options.className+" items",content:"Export task will be created, when data is ready you will be notified",type:"export"}).then(function(e){return t.Utils.require("notification").then(function(){s.notify({message:"Export data task created",type:"info",icon:"fa fa-download"},{timeout:5e3})})},function(e){t.Utils.require("notification").then(function(){t.Trace.captureException(e)})})},f.prototype.initialize=function(){var e=this,i={responsive:!0,deferRender:!0,serverSide:!0,processing:!0,ajax:function(i,o,n){function r(n){if(n.limit(i.length),i.start&&n.skip(i.start),i.order&&i.order.length){var r=i.columns[i.order[0].column].data;"asc"===i.order[0].dir?n.ascending(r):n.descending(r)}e._include&&n.include(e._include),n.find(e.queryOptions).then(function(t){var n={draw:i.draw,recordsTotal:e.___totalCount||0,recordsFiltered:e.___count,data:s.map(t,function(t){var e={DT_RowData:t};return s.each(i.columns,function(i,o){var n,s;""!==o.data&&(n=o.data.split("."),s=void 0!==t.get(n[0])?t.get(n[0]):t[n[0]],n.length>1?(e[n[0]]=e[n[0]]||{},e[n[0]][n[1]]=s?s.get(n[1]):null):e[n[0]]=s)}),e})};e._records=t,e.trigger("changed",t),o(n)}).catch(function(n){t.Trace.captureException(n),e.trigger("changed"),o({draw:i.draw,data:[],recordsTotal:0,recordsFiltered:0})})}if(e.where&&Object.keys(e.where).length&&e.where.parentClass&&e.where.fieldId&&e.where.objectId){var a=t.Object.fromJSON({className:e.where.parentClass,objectId:e.where.objectId});rqp=a.relation(e.where.fieldId).query()}("function"==typeof e.options.getSearchQuery?e.options.getSearchQuery:e.getSearchQuery).call(e,i.search?i.search.value:void 0).then(function(t){var n=JSON.stringify(t.toJSON());return e.__qcache===n?r(t):t.count(e.queryOptions).then(function(o){return i.search&&i.search.value&&""!==i.search.value||(e.___totalCount=o),e.___count=o,e.__qcache=n,r(t)},function(t){return e.onError(t),o({draw:i.draw,data:[],recordsTotal:0,recordsFiltered:0,error:t.message||t})})})}};if(s.each(this.options,function(t,e){"dt"===t.substring(0,2)&&(t=t.substring(2),i[t]=e)}),this._requires=["dataTablesResponsiveBoostrap"],i.columns&&i.columns.length||(i.columns=i.columns||this._getColumns()),!i.order)for(var n=0;n<i.columns.length&&!i.order;n++)i.columns[n].sortable&&(i.order=[[n,"asc"]]);if(s.each(i.columns||[],function(t,e){e.defaultContent=e.defaultContent||""}),i.drawCallback=i.drawCallback||this._drawCallback.bind(this),i.searchDelay=i.searchDelay||700,this.dtOptions=i,this.$el.on("init.dt",function(t,e){var i=new s.fn.dataTable.Api(e).table();s(i.container()).find(".dataTables_filter input").unbind().bind("input",function(t){(this.value.length>=3||13==t.keyCode)&&i.search(this.value).draw(),""==this.value&&i.search("").draw()})}),!1!==i.stateSave&&(i.stateSave=!0,i.stateLoadCallback=i.stateLoadCallback||function(i,o){var n=t.CoreManager.getStorageController().getItem(e._storageKey);o(n?JSON.parse(n):n)},i.stateSaveCallback=i.stateSaveCallback||function(i,o){t.CoreManager.getStorageController().setItem(e._storageKey,JSON.stringify(o))}),i.buttons||this.options.defaultButtons){if(this._requires.push(l?"datatables.net-buttons-bs4":"datatables.net-buttons-bs"),this._requires.push("datatables.buttons.colVis"),this._requires.push("datatables.buttons.print"),this.options.defaultButtons&&(i.buttons=i.buttons||[],!1!==this.options.pageLengthButton&&i.buttons.push("pageLength"),!1!==this.options.colvisButton&&i.buttons.push({extend:"colvis",text:'<i class="fa fa-eye"></i>'}),!1!==this.options.printButton&&i.buttons.push({extend:"print",text:'<i class="fa fa-print"></i>',exportOptions:{columns:":visible"}}),!1!==this.options.exportButton&&i.buttons.push({className:"btn btn-default btn-download",text:'<i class="fa fa-download"></i>',action:e._exportData.bind(e)}),this.options.createNew&&"function"==typeof this.options.onCreate)){var r="btn btn-default btn-add";this.options.aclCreate&&"*"!==this.options.aclCreate&&s.each(this.options.aclCreate.split(" "),function(t,e){e&&(r=r+" req-role-"+e)}),i.buttons.push({className:r,text:'<i class="fa fa-plus"></i>',action:e.options.onCreate.bind(e)})}i.dom=i.dom||"<'row'<'col-sm-6'B><'col-sm-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-5'i><'col-sm-7'p>>",l&&(s.fn.dataTableExt.classes.sWrapper="dataTables_wrapper  dt-bootstrap4")}return t.Utils.require(this._requires).then(function(){var t=e._requires.indexOf("moment");-1!==t&&(o=arguments[0][t]),e.dt=e.$el.DataTable(i)})},f.prototype._drawCallback=function(e){var i=this,o=new s.fn.dataTable.Api(e).table(),n=s(o.body());n.find("a.table-cmd-col").each(function(){var e=s(this),n=e.parents("tr"),r=s(n).hasClass("child")?s(n).prev():n,a=o.row(r).data();t.Utils.hasAccess(a.DT_RowData.getACL()).then(function(t){var o=t?i.options.iconButtonEdit:i.options.iconButtonView,n=t?i.options.classButtonEdit:i.options.classButtonView;e.addClass(n).html(o).show()})}),n.find(".btn").on("click",function(e){var n=s(e.currentTarget).data();if("function"==typeof i.options.onAction){var r=s(this).parents("tr"),a=s(r).hasClass("child")?s(r).prev():r,l=o.row(a).data();return i.options.onAction(n,l.DT_RowData,e.currentTarget),void e.preventDefault()}t.Router&&t.Router.lookup("data",n)&&(e.preventDefault(),t.Router.navigate(t.Router.lookup("data",n)))})},f.prototype._getColumn=function(e){var i=this,n={data:"objectId"===e.field?"id":e.field,type:e.type,sortable:void 0===e.sortable?-1!==["Number","Date","String","Boolean"].indexOf(e.type):e.sortable};return this.options.columns&&this.options.columns[e.field]?"function"==typeof this.options.columns[e.field]?this.options.columns[e.field](this,e):this.options.columns[e.field]:(e.targetClass&&(n.targetClass=e.targetClass),"objectId"===e.field?n.render=function(t,e,o,n){return'<a data-object-id="'+t+'" data-field-id="objectId" href="#" class="table-cmd-col '+i.options.classButtons+'" style="display:none"></a>'}:"Date"===e.type?(-1===i._requires.indexOf("moment")&&i._requires.push("moment"),n.render=function(t,n,s,r){return t&&void 0!==o&&o(t).isValid()?o(t).format(e.dateFormat||i.options.dateFormat||"lll"):t||'<i class="fa fa-calendar-o"></i>'}):"Pointer"===e.type?n.render=function(o){return o?o.className?'<a href="#" data-object-id="'+o.id+'" data-field-id="'+e.field+'" data-action="pointer" data-target-class="'+o.className+'" class="btn '+i.options.classButtons+' "><i class="fa fa-search"></i></a>'+("Files"===o.className?' <a href="'+t.serverURL+"/storage/"+t.applicationId+"/"+o.id+'" target="_blank"><i class="fa fa-download"></i></a>':""):o:""}:"Relation"===e.type?n.render=function(t){return t?'<a href="#"  data-object-id="'+(t.parent?t.parent.id:"")+'"  data-field-id="'+e.field+'" data-action="relation" data-target-class="'+(t.targetClassName||e.targetClass||e.className)+'"  class="'+i.options.classButtons+' btn-default"><i class="fa fa-search"></i> view ['+e.field+"] </a>":""}:"String"===e.type?n.render=function(t,e,i){return s("<div>"+(t||"")+"</div>").text().trunc(50,!0)}:"Object"===e.type?n.render=function(t){return t&&Object.keys(t).length?"[object]":""}:"Boolean"===e.type?n.render=function(t){return t?'<i class="fa fa-check-square-o"></i>':'<i class="fa fa-square-o"></i>'}:"File"===e.type?n.render=function(t){return(t=t&&t.toJSON?t.toJSON():t)?'<a href="'+t.url+'" target="_blank"><i class="fa fa-external-link"></i> '+(t.name?t.name.substr(t.name.indexOf("_")+1):"")+"</a>":""}:"Array"===e.type?n.render=function(t){return t?"[array]":"[]"}:"GeoPoint"===e.type?n.render=function(t){return t?"{geopoint}":"{geopoint:new}"}:"Number"===e.type&&(n.render=function(t){return s.isNumeric(t)?"function"==typeof t.format?t.format():t:""}),e.field&&n.sortable&&-1!==e.field.indexOf(".")&&(n.sortable=!1),n)},f.prototype._getColumns=function(){var t=this,e=[];return this.$("thead th").each(function(){var i,o=s(this).data();o.field&&((i=t._getColumn(o))&&e.push(i),t._colsData=t._colsData||{},t._colsData[o.field]=o)}),e},f.prototype.reload=function(){this.__qcache=null,this.dt.ajax.reload()},f.prototype.getSearchQuery=function(e){var i=this,n=new t.Query(this.options.className),r=[],a=[];return this.where&&(n._where=s.extend({},this.where)),s.each(this.dtOptions.columns,function(n,s){var l;if(s.targetClass&&-1!==s.mData.indexOf(".")&&-1===a.indexOf(s.mData.split(".")[0])&&a.push(s.mData.split(".")[0]),e&&s.data&&s.type)switch(s.type.toLowerCase()){case"pointer":case"string":s.data&&(-1===s.data.indexOf(".")?r.push(new t.Query(i.options.className).matches(s.data,new RegExp(e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))):i._colsData[s.data]&&i._colsData[s.data].targetClass&&(l=s.data.split("."),r.push(new t.Query(i.options.className).matchesQuery(l[0],new t.Query(i._colsData[s.data].targetClass).matches(l[1],new RegExp(e.replace(/[-\[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))))));break;case"num":case"number":s.data&&!isNaN(parseFloat(e,10))?r.push(new t.Query(i.options.className).equalTo(s.data,parseFloat(e,10))):i._colsData[s.data]&&i._colsData[s.data].targetClass&&(l=s.data.split("."),r.push(new t.Query(i.options.className).matchesQuery(l[0],new t.Query(i._colsData[s.data].targetClass).equalTo(l[1],parseFloat(e,10)))));break;case"date":s.data&&void 0!==o&&o(e).isValid()&&r.push(new t.Query(i.options.className).equalTo(s.data,o(e).toDate()))}}),this.options.columnsOnly&&n.select(s.map(this.dtOptions.columns,function(t){return t.mData})),a.length&&n.include(a),r.length&&n._orQuery(r),Promise.resolve(n)},f.prototype.onError=function(e){t.Trace.captureException(e),"function"==typeof this.options.onError&&this.options.onError.call(this,e)},f.render=function(e,i){t.Utils.render("default/templates/controls/dataset-grid",i).then(function(t){return e.html(t),new f(e.find("table"),i)})},f.prototype.hide=function(){this.trigger("hide"),s(this.dt.table().container()).hide()},f.prototype.show=function(){this.trigger("show"),s(this.dt.table().container()).show()},t.UI.DataTable=f,t.UI.DataTable.defaults=s.extend({},t.UI.Control.defaults,{defaultButtons:!0,classButtons:"btn btn-xs",classButtonEdit:"btn-success",classButtonView:"btn-default",iconButtonEdit:'<i class="fa fa-pencil-square-o"></i>',iconButtonView:'<i class="fa fa-search"></i>'}),m.prototype=Object.create(t.UI.Control.prototype),m.prototype.constructor=m,m.prototype.initialize=function(){var e=this,i=["export_renderers","c3_renderers"];return r&&(i.push("css!"+CDN_ROOT+"/vendor/pivottable/pivot.min.css"),i.push("css!"+CDN_ROOT+"/vendor/c3/c3.css")),t.Utils.require(i).then(function(){return s.extend(s.pivotUtilities.renderers,s.pivotUtilities.c3_renderers,s.pivotUtilities.export_renderers),t.UI.Control.prototype.initialize.call(e)})},m.prototype.render=function(){var e=this;return this.getData().then(function(i){var o="box.pivot."+t.applicationId+"."+(e.options.className||"cls"),n=JSON.parse(t.Storage.getItem(o)||"false")||e.options.pivot||{},r=e.$(e.options.selectContainer);return n.onRefresh=n.onRefresh||e._onRefresh.bind(e),r.length||(r=e.$el),s(r).pivotUI(i,n,!0),t.UI.Control.prototype.render.call(this)})},m.prototype.getData=function(){var e=this,i={};return"function"==typeof this.options.getData?this.options.getData.call(this):this.options.className&&this.options.pipeline?(this.options.useMasterKey&&t.masterKey&&(i={useMasterKey:!0}),t.Cloud.run("data_aggregate",{className:this.options.className,pipeline:this.options.pipeline},i).then(function(t){return"function"==typeof e.options.processData?e.options.processData.call(e,t):e._processData(t)})):Promise.resolve([])},m.prototype._onRefresh=function(e){var i="box.pivot."+t.applicationId+"."+(this.options.className||"cls"),o=JSON.parse(JSON.stringify(e));!1!==this.options.noStatus&&(delete o.aggregators,delete o.renderers,delete o.rendererOptions,delete o.localeStrings,t.Storage.setItem(i,JSON.stringify(o)))},m.prototype._processData=function(e){var i=t._.map(e,function(e){var i={};return t._.each(e,function(o,n){"_id"===n?t._.each(e[n],function(t,e){i[e]=t}):i[n]=o}),i});return Promise.resolve(i)},t.UI.PivotTable=m,t.UI.PivotTable.defaults={},y.prototype=Object.create(d.prototype),y.prototype.constructor=y,y.prototype.initialize=function(){var e,i=this,n=t.UI.Control.prototype.initialize.call(this);if(!this.options.readOnly&&this.options.removeButtonClass?this.$(this.options.removeButtonClass).click(function(t){t.preventDefault(),s(this).hasClass("disabled")||"function"==typeof i.options.onRemove&&i.options.onRemove(i)}):this.$(this.options.removeButtonClass).hide(),this.options.cancelButtonClass&&this.$(this.options.cancelButtonClass).click(function(t){t.preventDefault(),i.wire().then(function(){"function"==typeof i.options.onCancel&&i.options.onCancel(i)})}),!this.options.readOnly&&this.options.createButtonClass?this.$(this.options.createButtonClass).click(function(e){var o=s(e.currentTarget);e.preventDefault(),s(this).hasClass("disabled")||(o.hide(),i.update().then(function(){var t=i.options.useMasterKey?{useMasterKey:!0}:void 0;return i.trigger("saving"),i.model.save({},t)}).then(function(){return i._uploadFiles()}).then(function(){"function"==typeof i.options.onUpdated&&i.options.onUpdated(i),i.trigger("saved"),t.Utils.require("notification").then(function(){s.notify({message:c("Updated")+" !",icon:"fa fa-info-circle"},{type:"info"})}),!i.model&&i.model.id&&i._useEditorLock&&t.Socket.hasClient()&&(i._timerSync={className:i.model.className,objectId:i.model.id},i._lockSync()),o.show()}).catch(function(e){o.show(),"function"==typeof i.options.onError&&i.options.onError(e),e.validate||t.Utils.require("notification").then(function(){t.Trace.captureException(e)})}))}):this.$(this.options.createButtonClass).hide(),this.$("[data-is-html]").length){var a=this.$("[data-is-html]");e=["summernote"],r&&e.push("css!"+CDN_ROOT+"/vendor/summernote/summernote"),t.Utils.require(e).then(function(){a.each(function(t,e){vd=s(this).data("bm-field"),vd&&vd.split("$")[0]===i.options.className&&(i.wireSummernote(s(e)),s(e).summernote("code",s(e).val()))})})}return this.$(".input-group-btn .btn").click(function(o){var n=s(o.currentTarget).parents(".input-group"),a=n.find("input"),l=a.data("bm-field");l&&l.split("$")[0]===i.options.className&&(e=["summernote"],o.preventDefault(),r&&e.push("css!"+CDN_ROOT+"/vendor/summernote/summernote"),n.removeClass("input-group").find("button").hide(),t.Utils.require(e).then(function(){i.wireSummernote(a),a.summernote("code",a.val())}))}),this.$("select[data-field-target]").each(function(){var e=s(this).data("bm-field"),o={};i.options.useMasterKey&&(o={useMasterKey:!0}),e&&e.split("$")[0]===i.options.className&&(e=e.split("$")[1],i.options.selects&&i.options.selects[e]&&(o=s.extend(o,i.options.selects[e])),i.selects[e]=new t.UI.Select(this,o))}),this.$('input[data-field-type="Number"]').each(function(e,o){var n=s(this).data("bm-field");n&&n.split("$")[0]===i.options.className&&t.Utils.inputDigitsOnly(s(this))}),this.$('[data-field-type="Date"]').length&&(n=n.then(function(){return t.Utils.require(["moment","bootstrap-datetimepiker"]).then(function(t){o=t[0],i.$(".form-group .input-group.date").datetimepicker({format:i.options.dateFormat})})})),n=n.then(function(){return i.$(".editor-lock .users-open-close").length&&t.Socket.hasClient()?(i._useEditorLock=!0,i.$(".editor-lock .users-open-close").click(function(t){t.preventDefault(),s(this).parent().toggleClass("open")}),t.Socket.client().then(function(t){t.on("edit",function(t){i._showLocks(t)})})):Promise.resolve()})},y.prototype.wire=function(e,i){var n=this,a=Promise.resolve(),l=this.options.bindFilter||"[data-bm-field]";return e&&e.className&&e.className!==this.options.className?a:(this.model=e,this.__files=[],this.model&&this.model.id?(this.readOnly=this.options.readOnly,this.readOnly?(this.$(".readonly-field").show(),this.$(this.options.removeButtonClass).addClass("disabled"),this.$(this.options.createButtonClass).addClass("disabled")):(this.$(this.options.createButtonClass).html(this.options.updateButtonText),this.$(this.options.removeButtonClass).removeClass("disabled"),this.$(this.options.createButtonClass).removeClass("disabled"))):(this.readOnly=!1,this.$(".readonly-field").hide(),this.$(this.options.removeButtonClass).addClass("disabled"),this.$(this.options.createButtonClass).html(this.options.createButtonText),this.$(this.options.createButtonClass).removeClass("disabled")),this.$(l).each(function(){var i=this;a=a.then(function(){return function e(i,n,a){var l,c=s(this).data(),d=c.bmBind,p=c.bmDefault||"",u=[],h="change",f=i.options.bindFilter||"[data-bm-field]",m=c.bmField,y=Promise.resolve();if(c.bmUpdateOnly||!m||-1===m.indexOf("$"))return Promise.resolve();var g=this.nodeName;m=m.split("$");if(m[0]!==i.options.className)return Promise.resolve();m=m[1];d||("IMG"===g?(d="prop",u.push("src")):"INPUT"===g&&"checkbox"===this.type?(d="prop",u.push("checked")):d="INPUT"===g||"SELECT"===g||"TEXTAREA"===g?"val":"html");l=a||(n?n.get(m):p);l&&l.id&&l.className&&(l=l.id);if("string"==typeof l&&("String"===c.fieldType||0===d.indexOf("summernote;"))){if(l.trim().match(/^<[a-z][\s\S]*>/i)&&($input=s(this),$input.parents(".input-group").removeClass("input-group").find("button").hide(),!s(this).data("summernote"))){var v=["summernote"];return r&&v.push("css!"+CDN_ROOT+"/vendor/summernote/summernote"),t.Utils.require(v).then(function(){i.wireSummernote($input),$input.summernote("code",l),h="summernote.change",$input.off(h).on(h,function(){var t=s(this).val();"function"==typeof i.trigger&&i.trigger("change",m,t),i.$(f+'[data-bm-field="'+s(this).data("bm-field")+'"]').not(this).each(function(){e.call(this,i,n,t)})})})}s(this).data("summernote")&&(d="summernote;code",h="summernote.change")}if("Files"===c.fieldTarget)return i.__files.push(this),y;"Date"===c.fieldType&&(l=l&&void 0!==o&&o(l).isValid()?o(l).format(i.options.dateFormat):l);"Object"===c.fieldType&&(l=l?JSON.stringify(l):l);i.selects&&i.selects[m]?i.selects[m].val(l):("Pointer"===c.fieldType&&(l=n&&"function"==typeof n.get&&n.get(m)&&"function"==typeof n.get(m).get?n.get(m).get(c.searchFor||"name"):l),-1!==d.indexOf(";")&&(d=d.split(";"),u.push(d[1]),d=d[0]),u.push(l),s.fn[d].apply(s(this),u),"INPUT"===g&&"checkbox"===this.type&&s(this).trigger("change"));void 0===c.bmWithNoChange&&s(this).off(h).on(h,function(){var t=s(this).val();"function"==typeof i.trigger&&i.trigger("change",m,t),i.$(f+'[data-bm-field="'+s(this).data("bm-field")+'"]').not(this).each(function(){e.call(this,i,n,t)})});return y}.call(i,n,e)})}),(a=a.then(function(){var i=[],o=Promise.resolve();if(n.$(".file-placeholder .file-list").empty(),n.__files.length){if(e&&(s.each(n.__files,function(t,o){var n=s(o).data().bmField.split("$")[1],r=e.get(n);r&&i.push(r.id)}),i.length)){var r=new t.Query("Files");r.containedIn("objectId",i),o=r.find()}o=o.then(function(t){return Promise.all(s.map(n.__files,function(i){var o,r,a,l=s(i).data(),c=l.bmField.split("$")[1];if(e&&(r=e.get(c)))for(a=0;!o&&a<t.length;a++)t[a].id===r.id&&(o=t[a].toJSON());return n.files[l.bmField]||(n.files[l.bmField]={el:i,role:c}),n.renderImage(o,s(i))}))})}return o})).then(function(){return Promise.all(s.map(n.childrens||[],function(t){return t.wire(e,!0)}))}).then(function(){n.trigger("wired"),n.model&&n.model.id&&n._useEditorLock&&t.Socket.hasClient()&&(n._timerSync={className:n.model.className,objectId:n.model.id},n._lockSync())}))},y.prototype._lockSync=function(){var e=this;if(!this._timerSync)return e._showLocks();Promise.resolve().then(function(){return e.model&&!e.model.isNew()&&s.contains(document,e.$el[0])||(e._timerSync.leave=!0),t.Socket.client().then(function(t){return new Promise(function(i,o){t.emit("edit",e._timerSync,function(t){return e._timerSync.leave&&delete e._timerSync,e._showLocks(t).then(i,o)})})})}).then(function(){setTimeout(e._lockSync.bind(e),e.options.editSyncTimer)},function(){setTimeout(this._lockSync.bind(this),e.options.editSyncTimer)})},y.prototype._showLocks=function(t){var e=[],i="";return t&&this.model&&this.model.id===t.object.objectId?(s.each(t,function(t,o){"object"!==t&&(e.push(o),i+='<li><i class="fa fa-user"></i> {username}</li>'.format(o.editor.user))}),e.length>1?(this.$(".editor-lock").show(),this.$(".editor-lock .lock-list-body ul").html(i)):this.$(".editor-lock").hide(),Promise.resolve()):(this.$(".editor-lock").hide(),Promise.resolve())},y.prototype.addChilds=function(t){this.childrens=this.childrens||[],t.parent=this,this.childrens.push(t)},y.prototype._uploadFiles=function(){var e=this;return Promise.all(s.map(this.files,function(i){return s(i.el).val()?new Promise(function(o,n){var r,a,l=s(i.el).parents(".input-file"),c=(l.find('input[type="file"]')||[])[0];if(c&&c.files&&c.files.length)return r=c.files[0],l.find(".file-edit").hide(),l.find(".fileinput-button").hide(),l.find(".progress").show(),a={role:i.role,className:e.options.className,name:r.name,contentType:r.type||"application/octet-stream"},e.model&&e.model.id&&(a.objectId=e.model.id),t.Cloud.run("createPresignedPost",a).then(function(a){var c,d=new FormData;t.$.each(a.fields,function(t,e){d.append(t,e)}),d.append("file",r),a.file&&(a.file.className=a.file.className||"Files",c=t.Object.fromJSON(a.file)),t.$.ajax({url:a.url,type:"POST",data:d,processData:!1,contentType:!1,success:function(s){return Promise.resolve().then(function(){var o=e.options.useMasterKey?{useMasterKey:!0}:void 0,n=[];if(a.file)return r.size&&c.set("size",r.size),r.lastModifiedDate&&c.set("lastModified",r.lastModifiedDate),c.set("key",a.fields.key),"public-read"===a.fields.ACL&&c.set("url",a.url+"/"+a.fields.key),n.push(c),e.model&&(e.model.set(i.role,c),n.push(e.model)),t.Object.saveAll(n,o).then(function(){return c})}).then(function(i){t.Object.fromJSON(a.file);l.find(".file-edit").show(),l.find(".file-edit").val(""),l.find(".fileinput-button").show(),l.find(".progress").hide(),l.find('input[type="file"]').val(""),e.renderImage(i?i.toJSON():null,l).then(o,n)}).then(o,n)},error:function(){l.find(".progress").hide(),l.find(".file-edit").show(),l.find(".fileinput-button").show(),n()},xhr:function(){return myXhr=s.ajaxSettings.xhr(),myXhr.upload?myXhr.upload.addEventListener("progress",function(t){if(t.lengthComputable){var e=Math.floor(t.loaded/t.total*100);l.find(".progress span").html(e<95?e+"%":"sending to cloud.."),l.find(".progress .progress-bar").css({width:e+"%"})}},!1):(l.find(".progress").hide(),console.log("Uploadress is not supported.")),myXhr}})},function(){l.find(".progress").hide(),l.find(".file-edit").show(),l.find(".fileinput-button").show(),n(message)})}):Promise.resolve()})).then(function(){e.options.useMasterKey}).catch(function(i){t.Utils.require("notification").then(function(){t.Trace.captureException(i)}),"function"==typeof e.options.onError&&e.options.onError(i)})},y.prototype.renderImage=function(e,i){var o=this,n=Promise.resolve();if(e){var s=e.url?e.url:t.serverURL+"/storage/"+t.applicationId+"/"+e.objectId,r=i.parents(".file-placeholder").find(".file-list");r.length||(i.parents(".file-placeholder").prepend('<ul class="file-list"></ul>'),r=i.parents(".file-placeholder").find(".file-list")),r.empty(),r.append(o.options.imageFormat.format({display:e.contentType&&0===e.contentType.indexOf("image/")?'<img src="'+s+'">':'<i class="fa fa-file"></i>',name:e.name,id:e.objectId,url:s,size:e.size.toByteSize()})),r.find("a.text-danger:last").click(function(n){var s=i.data();n.preventDefault(),t.Utils.require("bootstrap-dialog").then(function(n){n.confirm({title:"Aten»õie",type:n.TYPE_WARNING,message:"<i class='fa fa-trash-o text-danger'></i> "+c("Remove")+" <i>"+e.name+"</i> ?",closable:!0,btnCancelLabel:'<i class="fa fa-ban"></i> '+c("Cancel")+" !",btnOKLabel:'<i class="fa fa-trash-o"></i> '+c("Delete")+"!",btnOKClass:"btn-danger",callback:function(e){if(e){var n,r=s.bmField.split("$")[1];return o.options.useMasterKey&&{useMasterKey:!0},n=o.model.get(r),o.model.set(r,null),n&&n.set("purged",!0),t.Object.saveAll([n,o.model]).then(function(){o.renderImage(null,i)})}}})})})}else i.parents(".file-placeholder").find(".file-list").remove();return n},y.prototype.validate=function(){var e,i=this,o=(this.options.bindFilter||"[data-bm-field]")+"[data-bm-required]",n=Promise.resolve();return this.$(o).each(function(){var i=s(this).data(),o=i.bmBind,r=[];if(!o){var a=this.nodeName;"IMG"===a?(o="prop",r.push("src")):"INPUT"===a&&"checkbox"===this.type?(o="prop",r.push("checked")):o="INPUT"===a||"SELECT"===a||"TEXTAREA"===a?"val":"html"}s(this).data("summernote")&&(o="summernote;code"),-1!==o.indexOf(";")&&(o=o.split(";"),r.push(o[1]),o=o[0]),s.fn[o].apply(s(this),r)||(e=e||{field:i.bmField,validate:!0,message:i.bmRequiredError||i.bmField.split("$").join(" ")+" "+c("is required")},n=n.then(function(){return t.Utils.require("notification").then(function(){s.notify({message:i.bmRequiredError||i.bmField.split("$").join(" ")+" "+c("is required"),icon:"fa fa-exclamation-circle"},{type:"danger",timer:5e3})})}))}),e&&(n=n.then(function(){return Promise.reject(e)})),n.then(function(){return Promise.all(s.map(i.childrens||[],function(t){return t.validate()}))})},y.prototype.wireSummernote=function(e,i){var o=this;e.data("summernote")||(o.options.summernote=o.options.summernote||{},t._.defaults(o.options.summernote,{height:"300px",focus:!1,tabsize:2,dialogsInBody:!0,callbacks:{onChange:function(t){s(this).val(t)},onImageUpload:function(i){var n=s(this).data("summernote").modules.editor,r=o.options.useMasterKey?{useMasterKey:!0}:void 0,a=Promise.resolve(),l=o.options.fileRole||!!e.data("bm-field")&&e.data("bm-field").split("$")[1]||"attachment",d=i[0];return o.model&&o.model.isNew()&&(a=a.then(function(){return a.save({},r)})),a.then(function(){var i;(o.options.fileRole||e.data("bm-field"))&&e.data("bm-field").split("$")[1];return e.parent().find(".summer-progress").show(),i={role:l,className:o.options.className,name:d.name,inline:!0,contentType:d.type||"application/octet-stream"},o.model&&o.model.id&&(i.objectId=o.model.id),t.Cloud.run("createPresignedPost",i).then(function(i){var o,a=new FormData;return t.$.each(i.fields,function(t,e){a.append(t,e)}),a.append("file",d),i.file&&(i.file.className=i.file.className||"Files",o=t.Object.fromJSON(i.file)),new Promise(function(l,p){t.$.ajax({url:i.url,type:"POST",data:a,processData:!1,contentType:!1,success:function(s){return Promise.resolve().then(function(){if(i.file)return d.size&&o.set("size",d.size),d.lastModifiedDate&&o.set("lastModified",d.lastModifiedDate),o.set("key",i.fields.key),"public-read"===i.fields.ACL&&o.set("url",i.url+"/"+i.fields.key),o.save({},r)}).then(function(i){n.restoreRange(),i&&n.insertImage(t.serverURL+"/storage/"+t.applicationId+"/"+i.id,i.get("name")),e.parent().find(".summer-progress").hide(),l()}).then(l,p)},error:function(){e.parent().find(".summer-progress").hide(),p()},xhr:function(){return myXhr=s.ajaxSettings.xhr(),myXhr.upload?myXhr.upload.addEventListener("progress",function(t){if(t.lengthComputable){var i=Math.floor(t.loaded/t.total*100);e.parent().find(".summer-progress span").html(i<95?i+"%":c("sending to cloud..")),e.parent().find(".summer-progress .progress-bar").css({width:i+"%"})}},!1):e.parent().find(".summer-progress").hide(),myXhr}})})},function(t){e.parent().find(".summer-progress").hide()})})}}}),e.summernote(o.options.summernote),e.parent().css("position","relative"),e.parent().append(o.options.progressBar))},y.prototype.update=function(){var e,i=this,n=this.options.bindFilter||"[data-bm-field]";return this.model||this.options.className?(e=this.validate(),this.model||(this.$('input[name="objectId"]').val()?this.model=new t.Object.fromJSON({className:this.options.className,objectId:this.$('input[name="objectId"]').val()}):this.model=new t.Object(this.options.className)),this.$(n).each(function(){var n,r,a=s(this).data(),l=a.bmBind,c=[];if(!(a.bmDisplayOnly||"Files"===a.fieldTarget&&"Pointer"===a.fieldType)&&(n=(n=-1===a.bmField.indexOf(";")?a.bmField:a.bmField.split(";")).split("$"))[0]===i.options.className){if(n=n[1],!l){var d=this.nodeName;if(-1!==(i.options.readOnlyBind||["P","DIV"]).indexOf(d))return;"IMG"===d?(l="prop",c.push("src")):"INPUT"===d&&"checkbox"===this.type?(l="prop",c.push("checked")):l="INPUT"===d||"SELECT"===d||"TEXTAREA"===d?"val":"html"}if(s(this).data("summernote")&&(l="summernote;code"),-1!==l.indexOf(";")&&(l=l.split(";"),c.push(l[1]),l=l[0]),r=s.fn[l].apply(s(this),c),"Number"===a.fieldType||"slider"===a.fieldType){var p=parseFloat(r);r=isNaN(p)?null:p}else"Boolean"===a.fieldType&&"string"==typeof r?r="true"===r.toLowerCase():"Pointer"===a.fieldType?r=r?t.Object.fromJSON({className:a.fieldTarget,objectId:r}):null:"String"===a.fieldType?r=r.trim():"Date"===a.fieldType?r=r&&void 0!==o&&o(r,i.options.dateFormat).isValid()?o(r,i.options.dateFormat).toDate():null:"Object"===a.fieldType&&(r=r?JSON.parse(r):null);"Relation"===a.fieldType?i.selects[n]&&(e=e.then(function(){return i.selects[n].syncRelation(i.model)})):i.model.set(n,r)}}),e.then(function(){return Promise.all(s.each(i.childrens||[],function(t){return t.update()}))})):Promise.reject(new Error("Invalid binding"))},y.prototype.destroy=function(){var e=this,i=this.childrens||[];return s.each(this.selects,function(t,e){"function"==typeof e.destroy&&i.push(e.destroy())}),s.when.apply(s,i).then(function(){return t.UI.Control.prototype.destroy.call(e)})},t.UI.Editor=y,t.UI.Editor.defaults=s.extend({},t.UI.Control.defaults,{cancelButtonClass:"footer .btn-default",createButtonClass:"footer .btn-success",removeButtonClass:"footer .btn-danger",createButtonText:'<i class="fa fa-plus"></i> Create',updateButtonText:'<i class="fa fa-floppy-o"></i> Update',imageFormat:'<li data-object-id="{id}"><div class="well well-sm"><span>{display}</span><br><strong>{name}</strong><br>{size}<br><a href="{url}" target="_blank"><i class="fa fa-download"></i> Download</a>  | <a href="#" data-file-id="{id}" class="text-danger"><i class="fa fa-times"></i> Remove</a></div></li>',progressBar:'<div class="summer-progress" style="display:none"><div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;"><span>0%</span></div></div>',bindFilter:"[data-bm-field]",dateFormat:"DD-MM-YYYY",editSyncTimer:3e4}),g.prototype=Object.create(d.prototype),g.prototype.constructor=g,g.prototype.initialize=function(){var e=this,i=this.$el.prop("id"),o={onAction:this.onAction.bind(this),onUpdated:function(){e.grid.reload(),e.trigger("saved")},onCreate:function(){var i=new t.Object(e.options.className);e.wire(i)},onCancel:function(){e.grid.show(),e.editor.hide(),e.trigger("canceled"),s("html, body").animate({scrollTop:e.grid.$el.offset().top-(e.options.scrollTopOffset||150)},200)}},n=s.extend({},o,this.options);return this.grid=this.options.grid||new f(this.$(this.options.gridId?this.options.gridId:i?"#"+i+"-table":"table.box-table"),n),this.editor=this.options.editor||new y(this.$(this.options.editorId?this.options.editorId:i?"#"+i+"-form":"form.box-editor"),n),t._.defaults(this.editor.options,o),Promise.all([this.editor.p||Promise.resolve(),this.grid.p||Promise.resolve()]).then(function(){return t.UI.Control.prototype.initialize.call(e)})},g.prototype.onAction=function(t,e,i){t.fieldId&&t.objectId&&this.wire(e)},g.prototype.wire=function(t){this.grid.hide(),this.editor.$el.removeClass("hidden").show(),this.editor.wire(t),this.trigger("wired")},g.prototype.showGrid=function(t){this.editor.hide(),this.grid.show(),t&&this.grid.reload()},g.prototype.destroy=function(){var e=this,i=[];return this.editor&&"function"==typeof this.editor.destroy&&i.push(this.editor.destroy()),this.grid&&"function"==typeof this.grid.destroy&&i.push(this.grid.destroy()),s.when.apply(s,i).then(function(){return t.UI.Control.prototype.destroy.call(e)})},t.UI.DataSet=g,t.UI.DataSet.defaults={}});