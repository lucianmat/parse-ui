!function(t,e){if("function"==typeof define&&define.amd)define(["Box","module","require"],e);else{e(Box)}}(0,function(t,e,i){var o,n,s=t.$,r=void 0===e.config().loadCss||e.config().loadCss,a=void 0!==e.config().i18n&&e.config().i18n,l=void 0!==e.config().bs4&&e.config().bs4,c=void 0!==e.config().fa5&&e.config().fa5,d=void 0!==e.config().lazyEdit&&e.config().lazyEdit;function p(t){return a&&(n=n||i("i18next"))&&"function"==typeof n.t&&n.t(t)||t}function u(e,i){var o=this;this.cid=t._.uniqueId("view"),this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.Control.defaults,this.$el.data(),i||{}),this.p=this.p||this.options.p||Promise.resolve(),this.p.then(function(){var t;if(!o.options.domLink)return Promise.resolve();(t=o.$el.data(o.options.domLink))&&"function"==typeof t.destroy&&(t.destroy(),o.options[o.options.domLink]&&(o.options[o.options.domLink]=null)),o.$el.data(o.options.domLink,o)}).then(function(){return o.initialize()})}"undefined"==typeof CDN_ROOT&&(CDN_ROOT=""),t.UI=t.UI||{};var h=/^(\S+)\s*(.*)$/;function f(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.View.defaults,this.$el.data(),i||{}),this.$container=this.$el.find(this.options.selectContainer),this.$messages=this.$el.find(this.options.messagesContainer),this.childrens=[],t.UI.Control.call(this,e,this.options)}function m(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.Select.defaults,this.$el.data(),i||{}),this.options.className=this.options.className||this.$el.data("field-target"),this.options.field=this.options.field||this.$el.data("bm-field").split("$")[1],this.options.parentClass=this.options.parentClass||this.$el.data("bm-field").split("$")[0],this.options.searchFor=this.options.searchFor||s(e).data("search-for")||t.UI.Select.defaults.mapSearch[this.options.className]||"name",this.options.display=this.options.display||s(e).data("display"),this.options.relation=this.options.relation||"Relation"===this.$el.data("field-type"),this.options.preload=this.options.preload||!!this.$el.data("preload"),this.options.withData=this.options.withData||!!this.$el.data("with-data"),this.options.order=this.options.order||this.$el.data("order"),t.UI.Control.call(this,e,s.extend({},t.UI.Select.defaults,i||{}))}function y(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.DataTable.defaults,this.$el.data(),i||{}),this.options.className=this.options.className||this.$el.data("class-name"),this.queryOptions=this.options.query||{},this.where=this.options.where||{},this._include=this.options.include||this.$el.data("query-include"),this._storageKey=this._storageKey||this.$el.attr("id")||"DataSet:"+this.options.className+"#"+(this.$el.parents(".jarviswidget").eq(0).attr("id")||"")+":"+(t.User.current()?t.User.current().id:"*"),t.UI.Control.call(this,e,s.extend({},t.UI.DataTable.defaults,i||{}))}function g(e,i){this.$el=s(e),this.options=s.extend({},t.UI.PivotTable.defaults,i||{}),t.UI.Control.call(this,e,this.options)}function v(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.Editor.defaults,s(this.$el).data(),i||{}),this.readOnly=!0,this.selects=this.selects||{},this.files=this.files||{},t.UI.Control.call(this,e)}function b(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.Gallery.defaults,s(this.$el).data(),i||{}),t.UI.Editor.call(this,e),this.readOnly=!1}function w(e,i){this.$el=this.$el||s(e),this.options=this.options||s.extend({},t.UI.DataSet.defaults,this.$el.data(),i||{}),this.options.className=this.options.className||this.$el.data("class-name"),void 0===this.options.createNew&&(this.options.createNew=!!this.$el.data("acl-create")),t.UI.Control.call(this,e)}s.extend(u.prototype,t.Events,{$:function(t){return this.$el.find(t)},destroy:function(){return this.trigger("destroy"),this._removeElement(),this.stopListening(),this.p},_removeElement:function(){this.$el.remove()},initialize:function(){var e=this,i=Array.prototype.slice.call(arguments);return this.options.events&&this.delegateEvents(this.options.events),this.options.controller&&(this.p=this.p.then(function(){return t.Utils.require(e.options.controller.src||e.options.controller).then(function(t){"function"==typeof t?e.controller=new t(e):t&&"function"==typeof t.getController?e.controller=t.getController(e):t&&"function"==typeof t.init&&t.init.call(e,e.$el)})})),this.p.then(function(){return e.trigger("initialized"),e.render.apply(e,i)})},render:function(){return this.trigger("rendered"),this.p},show:function(){this.trigger("show"),this.$el.show()},hide:function(){this.trigger("hide"),this.$el.hide()},delegateEvents:function(e){if(!(e=e||(e=t._.result(this,"events"))))return this;for(var i in this.undelegateEvents(),e){var o=e[i];if(t._.isFunction(o)||(o=this[o]),o){var n=i.match(h);this.delegate(n[1],n[2],t._.bind(o,this))}}return this},delegate:function(t,e,i){return this.$el.on(t+".delegateEvents"+this.cid,e,i),this.on(t,i),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this.off(),this},undelegate:function(t,e,i){return this.$el.off(t+".delegateEvents"+this.cid,e,i),this.off(t,i),this},_setAttributes:function(t){this.$el.attr(t)}}),u.prototype.constructor=u,t.UI.Control=u,t.UI.Control.defaults={domLink:"box.control",constructorClass:"box.constructor"},f.prototype=Object.create(u.prototype),f.prototype.constructor=f,f.prototype.initialize=function(){var e=this;return t.UI.Control.prototype.initialize.call(this).then(function(){return e.loadChildrens()})},f.prototype.showMessage=function(t){return this.$messages.html(t)},f.prototype.cleanChildrens=function(){var t,e=this,i=[],o=s.grep(this.childrens||[],function(t){return"function"==typeof t.destroy});for(t=0;t<o.length;t++)i.push(o[t].destroy());return s.when.apply(s,i).then(function(){for(var t,i=(e.childrens||[]).length;i--;)"function"==typeof(t=e.childrens.pop()).destroy&&t.destroy(),delete t;return e.childrens=[],Promise.resolve()})},f.prototype.loadChildrens=function(e){var i=[],o=this;return this.p=this.p.then(function(){return o.$container.find(o.options.childControls).each(function(n,r){var a,l,c=s(r).data("controller");if("function"==typeof o.options.childConstructor)return l=new o.options.childConstructor(r,e),o.childrens.push(l),void(l.p&&i.push(l.p));c&&(a=t.Utils.require(c).then(function(t){if(t&&"function"==typeof t.init)return t.init(r,o,e)}).then(function(){var t=s(r).data(o.options.domLink);t&&o.childrens.push(t)}).catch(function(e){t.Trace.captureException(e)}),i.push(a))}),Promise.all(i)}),this.p},f.prototype.load=function(e,i){var o=this;return i&&(e=e+"?"+t.Utils.querystring.stringify(i)),s.ajax({type:"GET",url:e,dataType:"html",beforeSend:function(e){o.showMessage(t.UI.View.defaults.loadingHtml),o.$container.css({opacity:"0.0"})}}).then(function(t){return o.cleanChildrens().then(function(){return o.$messages.hide(),o.$container.html(t).delay(50).animate({opacity:"1.0"},300),o.loadChildrens(i)})},function(i,n,s){o.showMessage(t.UI.View.defaults.errorHtml.format({url:e,status:i.status,err:s})),o.$container.animate({opacity:"1.0"},300)})},f.prototype.destroy=function(){var e=this;return this.cleanChildrens().then(function(){return t.UI.Control.prototype.destroy.call(e)})},t.UI.View=f,t.UI.View.defaults=s.extend({},t.UI.Control.defaults,{loadingHtml:'<h1 class="ajax-loading-animation"><i class="fa fa-cog fa-spin"></i> '+p("Loading")+"...</h1>",errorHtml:'<h4 class="ajax-loading-error"><i class="fa '+(c?"fa-exclamation-triangle":" fa-warning ")+(l?"text-warning":"txt-color-orangeDark")+'"></i> '+p("Error requesting")+' <span class="'+(l?"text-danger":"txt-color-red")+'">{url}</span>: {status} <span style="text-transform: capitalize;"> {err}</span></h4>',selectContainer:"box-content-container",messagesContainer:"box-messages-container",childControls:"[data-controller]"}),m.prototype=Object.create(u.prototype),m.prototype.constructor=m,m.prototype.initialize=function(){var e=this;return t.UI.Control.prototype.initialize.call(this),this.p=this.p.then(function(){return new Promise(function(i,o){var n=Promise.resolve(),r=e.options;return e.query?i():(this.__initial=[],e.query=r.query||new t.Query(r.className),r.display&&-1!==r.display.indexOf(".")&&r.display.split(";").forEach(function(t){var i=t.split(".");i.length>1&&e.query.include(i[0])}),r.order&&(e.query._order=r.order.split(",")),r.include&&e.query.include(r.include),s.fn.select2||(n=t.Utils.require(["select2"])),n.then(function(){var i={};return void 0!==r.useMasterKey&&t.masterKey&&(i.useMasterKey=r.useMasterKey),r.preload?e.query.find(i).then(function(t){var i=s.map(t,function(t){return'<option value="'+encodeURI(t.id)+'">'+(e.options.display||e.options.searchFor).split(",").map(function(e){return t.get(e)||""}).join(", ")+"</option>"}).join("");e.$el.html(i),e.$el.select2(s.extend({width:r.relation?"100%":r.width,allowClear:!e.options.bmRequired,placeholder:e.options.placeholder||"Select "+e.options.className},r)),e.$el.on("select2:select",function(){e.$el.data("select2").trigger("selection:update",{data:s(this).val()?s(this).select2("data"):[]})}),e.options.bmRequired||e.$el.on("select2:unselect",function(t){e.$el.data("select2").trigger("selection:update",{data:[]})})}):r.withData?(e.$el.select2(s.extend({width:r.relation?"100%":r.width,allowClear:!e.options.bmRequired,placeholder:e.options.placeholder||"Select "+e.options.className},r)),e.$el.on("select2:select",function(){e.$el.data("select2").trigger("selection:update",{data:s(this).val()?s(this).select2("data"):[]})}),void(e.options.bmRequired||e.$el.on("select2:unselect",function(t){e.$el.data("select2").trigger("selection:update",{data:[]})}))):(e.$el.select2(s.extend({width:r.relation?"100%":r.width,minimumInputLength:e.options.minimumInputLength||3,allowClear:!e.options.bmRequired,placeholder:e.options.placeholder||p("Select")+" "+e.options.className,ajax:{delay:e.options.delay||250,transport:e.options.transport||function(t,o,n){e.options.searchFor.split(",").forEach(function(i){e.query.matches(i,new RegExp(t.data.q.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))}),e.query.find(i).then(o,n)},processResults:e.options.processResults||function(t,i){var o=(e.options.display||e.options.searchFor).split(",");return{results:s.map(t,function(t){return{id:t.id,text:o.map(function(e){var i=e.split("."),o=e,n=t;return i.length>1&&(n=t.get(i[0]),o=i[1]),n.get(o)||""}).join(", ")}})}}}},r)),void(e.options.bmRequired||e.$el.on("select2:unselect",function(t){e.$el.empty()})))}).then(i,o))})}),this.p},m.prototype.val=function(e,i){var o,n=this;return this.options.preload||this.options.withData?(o=n.$el.data("select2"),n.$el.val(e).trigger("change"),o.selection&&"function"==typeof o.data&&"function"==typeof o.selection.update&&o.selection.update(o.data())):this.p=this.p.then(function(){var o,r=i||new t.Query(n.options.className);return n.$el.empty().trigger("change"),e?(n.options.relation&&!i?r=e.parent.relation(n.options.field).query():"string"==typeof e&&r.equalTo("objectId",e),n.options.useMasterKey&&t.masterKey&&(o={useMasterKey:!0}),r.find(o).then(function(t){n.__initial=t,n.$el.html(s.map(t,function(t){return'<option value="{id}" selected="selected">{text}</option>'.format({id:t.id,text:t.get(n.options.searchFor)})}).join("")).trigger("change")})):Promise.resolve()}),this.p},m.prototype.syncRelation=function(e){var i=this;return this.p=this.p.then(function(){var o=i.$el.val();if(!i.options.relation||!e)return Promise.resolve();s.each(i.__initial,function(t,n){-1===o.indexOf(n.id)&&e.relation(i.options.field).remove(n)}),s.each(o,function(o,n){s.grep(i.__initial,function(t){return t.id===n}).length||e.relation(i.options.field).add(t.Object.fromJSON({className:i.options.className,objectId:n}))})}),this.p},m.prototype.destroy=function(){return this.$el.select2("destroy"),t.UI.Control.prototype.destroy.call(this)},t.UI.Select=m,t.UI.Select.defaults=s.extend({},t.UI.Control.defaults,{width:"250px",mapSearch:{_User:"username",Files:"fileName"}}),y.prototype=Object.create(u.prototype),y.prototype.constructor=y,y.prototype._exportData=function(e,i,o,n){i.settings()[0].aoColumns;var r=i.columns(":visible")[0].map(function(t){return i.settings()[0].aoColumns[t].field});t.CoreManager.getRESTController().request("POST","tasks/create",{query:this.__qcache,className:this.options.className,items:r,title:"Export "+this.options.className+" items",content:"Export task will be created, when data is ready you will be notified",type:"export"}).then(function(e){return t.Utils.require("notification").then(function(){s.notify({message:"Export data task created",type:"info",icon:"fa fa-download"},{timeout:5e3})})},function(e){t.Utils.require("notification").then(function(){t.Trace.captureException(e)})})},y.prototype.initialize=function(){var e=this,i={responsive:!0,deferRender:!0,serverSide:!0,processing:!0,ajax:function(i,o,n){function r(n){if(n.limit(i.length),i.start&&n.skip(i.start),i.order&&i.order.length){var r=i.columns[i.order[0].column].data;"asc"===i.order[0].dir?n.ascending(r):n.descending(r)}e._include&&n.include(e._include),n.find(e.queryOptions).then(function(t){var n={draw:i.draw,recordsTotal:e.___totalCount||0,recordsFiltered:e.___count,data:s.map(t,function(t){var e={DT_RowData:t};return s.each(i.columns,function(i,o){var n,s;""!==o.data&&(n=o.data.split("."),s=void 0!==t.get(n[0])?t.get(n[0]):t[n[0]],n.length>1?(e[n[0]]=e[n[0]]||{},e[n[0]][n[1]]=s?s.get(n[1]):null):e[n[0]]=s)}),e})};e._records=t,e.trigger("changed",t),o(n)}).catch(function(n){t.Trace.captureException(n),e.trigger("changed"),o({draw:i.draw,data:[],recordsTotal:0,recordsFiltered:0})})}if(e.where&&Object.keys(e.where).length&&e.where.parentClass&&e.where.fieldId&&e.where.objectId){var a=t.Object.fromJSON({className:e.where.parentClass,objectId:e.where.objectId});rqp=a.relation(e.where.fieldId).query()}("function"==typeof e.options.getSearchQuery?e.options.getSearchQuery:e.getSearchQuery).call(e,i.search?i.search.value:void 0).then(function(t){var n=JSON.stringify(t.toJSON());return e.__qcache===n?r(t):t.count(e.queryOptions).then(function(o){return i.search&&i.search.value&&""!==i.search.value||(e.___totalCount=o),e.___count=o,e.__qcache=n,r(t)},function(t){return e.onError(t),o({draw:i.draw,data:[],recordsTotal:0,recordsFiltered:0,error:t.message||t})})})}};if(s.each(this.options,function(t,e){"dt"===t.substring(0,2)&&(t=t.substring(2),i[t]=e)}),this._requires=["dataTablesResponsiveBoostrap"],i.columns&&i.columns.length||(i.columns=i.columns||this._getColumns()),!i.order)for(var n=0;n<i.columns.length&&!i.order;n++)i.columns[n].sortable&&(i.order=[[n,"asc"]]);if(s.each(i.columns||[],function(t,e){e.defaultContent=e.defaultContent||""}),i.drawCallback=i.drawCallback||this._drawCallback.bind(this),i.searchDelay=i.searchDelay||700,this.dtOptions=i,this.$el.on("init.dt",function(t,e){var i=new s.fn.dataTable.Api(e).table();s(i.container()).find(".dataTables_filter input").unbind().bind("input",function(t){(this.value.length>=3||13==t.keyCode)&&i.search(this.value).draw(),""==this.value&&i.search("").draw()})}),!1!==i.stateSave&&(i.stateSave=!0,i.stateLoadCallback=i.stateLoadCallback||function(i,o){var n=t.CoreManager.getStorageController().getItem(e._storageKey);o(n?JSON.parse(n):n)},i.stateSaveCallback=i.stateSaveCallback||function(i,o){t.CoreManager.getStorageController().setItem(e._storageKey,JSON.stringify(o))}),i.buttons||this.options.defaultButtons){if(this._requires.push(l?"datatables.net-buttons-bs4":"datatables.net-buttons-bs"),this._requires.push("datatables.buttons.colVis"),this._requires.push("datatables.buttons.print"),this.options.defaultButtons&&(i.buttons=i.buttons||[],!1!==this.options.pageLengthButton&&i.buttons.push("pageLength"),!1!==this.options.colvisButton&&i.buttons.push({extend:"colvis",columns:":gt(0)",text:'<i class="fa fa-eye"></i>'}),!1!==this.options.printButton&&i.buttons.push({extend:"print",text:'<i class="fa fa-print"></i>',exportOptions:{columns:":visible"}}),!1!==this.options.exportButton&&i.buttons.push({className:"btn btn-default btn-download",text:'<i class="fa fa-download"></i>',action:e._exportData.bind(e)}),this.options.createNew&&"function"==typeof this.options.onCreate)){var r="btn btn-default btn-add";this.options.aclCreate&&"*"!==this.options.aclCreate&&s.each(this.options.aclCreate.split(" "),function(t,e){e&&(r=r+" req-role-"+e)}),i.buttons.push({className:r,text:'<i class="fa fa-plus"></i>',action:e.options.onCreate.bind(e)})}i.dom=i.dom||"<'row'<'col-sm-6'B><'col-sm-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-5'i><'col-sm-7'p>>",l&&(s.fn.dataTableExt.classes.sWrapper="dataTables_wrapper  dt-bootstrap4")}return t.Utils.require(this._requires).then(function(){var t=e._requires.indexOf("moment");-1!==t&&(o=arguments[0][t]),e.dt=e.$el.DataTable(i)})},y.prototype._drawCallback=function(e){var i=this,o=new s.fn.dataTable.Api(e).table(),n=s(o.body());n.find("a.table-cmd-col").each(function(){var e=s(this),n=e.parents("tr"),r=s(n).hasClass("child")?s(n).prev():n,a=o.row(r).data();t.Utils.hasAccess(a.DT_RowData.getACL()).then(function(t){var o=t?i.options.iconButtonEdit:i.options.iconButtonView,n=t?i.options.classButtonEdit:i.options.classButtonView;e.addClass(n).html(o).show()})}),n.find(".btn").on("click",function(e){var n=s(e.currentTarget).data();if("function"==typeof i.options.onAction){var r=s(this).parents("tr"),a=s(r).hasClass("child")?s(r).prev():r,l=o.row(a).data();return i.options.onAction(n,l.DT_RowData,e.currentTarget),void e.preventDefault()}t.Router&&t.Router.lookup("data",n)&&(e.preventDefault(),t.Router.navigate(t.Router.lookup("data",n)))})},y.prototype._getColumn=function(e){var i=this,n={data:"objectId"===e.field?"id":e.field,type:e.type,sortable:void 0===e.sortable?-1!==["Number","Date","String","Boolean"].indexOf(e.type):e.sortable};return this.options.columns&&this.options.columns[e.field]?"function"==typeof this.options.columns[e.field]?this.options.columns[e.field](this,e):this.options.columns[e.field]:(e.targetClass&&(n.targetClass=e.targetClass),"objectId"===e.field?n.render=function(t,e,o,n){return'<a data-object-id="'+t+'" data-field-id="objectId" href="#" class="table-cmd-col '+i.options.classButtons+'" style="display:none"></a>'}:"Date"===e.type?(-1===i._requires.indexOf("moment")&&i._requires.push("moment"),n.render=function(t,n,s,r){return t&&void 0!==o&&o(t).isValid()?o(t).format(e.dateFormat||i.options.dateFormat||"lll"):t||'<i class="fa fa-calendar-o"></i>'}):"Pointer"===e.type?n.render=function(o){return o?o.className?'<a href="#" data-object-id="'+o.id+'" data-field-id="'+e.field+'" data-action="pointer" data-target-class="'+o.className+'" class="btn '+i.options.classButtons+' "><i class="fa fa-search"></i></a>'+("Files"===o.className?' <a href="'+t.serverURL+"/storage/"+t.applicationId+"/"+o.id+'" target="_blank"><i class="fa fa-download"></i></a>':""):o:""}:"Relation"===e.type?n.render=function(t){return t?'<a href="#"  data-object-id="'+(t.parent?t.parent.id:"")+'"  data-field-id="'+e.field+'" data-action="relation" data-target-class="'+(t.targetClassName||e.targetClass||e.className)+'"  class="'+i.options.classButtons+' btn-default"><i class="fa fa-search"></i> view ['+e.field+"] </a>":""}:"String"===e.type?n.render=function(t,e,i){return s("<div>"+(t||"")+"</div>").text().trunc(50,!0)}:"Object"===e.type?n.render=function(t){return t&&Object.keys(t).length?"[object]":""}:"Boolean"===e.type?n.render=function(t){return t?'<i class="fa '+(c?"fa-check-square":"fa-check-square-o")+'"></i>':'<i class="fa '+(c?"fa-square":"fa-square-o")+'"></i>'}:"File"===e.type?n.render=function(t){return(t=t&&t.toJSON?t.toJSON():t)?'<a href="'+t.url+'" target="_blank"><i class="fa '+(c?"fa-external-link-alt":"fa-external-link")+'"></i> '+(t.name?t.name.substr(t.name.indexOf("_")+1):"")+"</a>":""}:"Array"===e.type?n.render=function(t){return t?"[array]":"[]"}:"GeoPoint"===e.type?n.render=function(t){return t?"{geopoint}":"{geopoint:new}"}:"Number"===e.type&&(n.render=function(t){return s.isNumeric(t)?"function"==typeof t.format?t.format():t:""}),e.field&&n.sortable&&-1!==e.field.indexOf(".")&&(n.sortable=!1),n)},y.prototype._getColumns=function(){var t=this,e=[];return this.$("thead th").each(function(){var i,o=s(this).data();o.field&&((i=t._getColumn(o))&&e.push(i),t._colsData=t._colsData||{},t._colsData[o.field]=o)}),e},y.prototype.reload=function(){this.__qcache=null,this.dt.ajax.reload()},y.prototype.getSearchQuery=function(e){var i=this,n=new t.Query(this.options.className),r=[],a=[];return this.where&&(n._where=s.extend({},this.where)),s.each(this.dtOptions.columns,function(n,s){var l;if(s.targetClass&&-1!==s.mData.indexOf(".")&&-1===a.indexOf(s.mData.split(".")[0])&&a.push(s.mData.split(".")[0]),e&&s.data&&s.type)switch(s.type.toLowerCase()){case"pointer":case"string":s.data&&(-1===s.data.indexOf(".")?r.push(new t.Query(i.options.className).matches(s.data,new RegExp(e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))):i._colsData[s.data]&&i._colsData[s.data].targetClass&&(l=s.data.split("."),r.push(new t.Query(i.options.className).matchesQuery(l[0],new t.Query(i._colsData[s.data].targetClass).matches(l[1],new RegExp(e.replace(/[-\[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"gi"))))));break;case"num":case"number":s.data&&!isNaN(parseFloat(e,10))?r.push(new t.Query(i.options.className).equalTo(s.data,parseFloat(e,10))):i._colsData[s.data]&&i._colsData[s.data].targetClass&&(l=s.data.split("."),r.push(new t.Query(i.options.className).matchesQuery(l[0],new t.Query(i._colsData[s.data].targetClass).equalTo(l[1],parseFloat(e,10)))));break;case"date":s.data&&void 0!==o&&o(e).isValid()&&r.push(new t.Query(i.options.className).equalTo(s.data,o(e).toDate()))}}),this.options.columnsOnly&&n.select(s.map(this.dtOptions.columns,function(t){return t.mData})),a.length&&n.include(a),r.length&&n._orQuery(r),Promise.resolve(n)},y.prototype.onError=function(e){t.Trace.captureException(e),"function"==typeof this.options.onError&&this.options.onError.call(this,e)},y.render=function(e,i){t.Utils.render("default/templates/controls/dataset-grid",i).then(function(t){return e.html(t),new y(e.find("table"),i)})},y.prototype.hide=function(){this.trigger("hide"),s(this.dt.table().container()).hide()},y.prototype.show=function(){this.trigger("show"),s(this.dt.table().container()).show()},t.UI.DataTable=y,t.UI.DataTable.defaults=s.extend({},t.UI.Control.defaults,{defaultButtons:!0,classButtons:l?"btn btn-sm":"btn btn-xs",classButtonEdit:"btn-success",classButtonView:"btn-default",iconButtonEdit:c?'<i class="fa fa-edit"></i>':'<i class="fa fa-pencil-square-o"></i>',iconButtonView:'<i class="fa fa-search"></i>'}),g.prototype=Object.create(t.UI.Control.prototype),g.prototype.constructor=g,g.prototype.initialize=function(){var e=this,i=["export_renderers","c3_renderers"];return r&&(i.push("css!"+CDN_ROOT+"/vendor/pivottable/pivot.min.css"),i.push("css!"+CDN_ROOT+"/vendor/c3/c3.css")),t.Utils.require(i).then(function(){return s.extend(s.pivotUtilities.renderers,s.pivotUtilities.c3_renderers,s.pivotUtilities.export_renderers),t.UI.Control.prototype.initialize.call(e)})},g.prototype.render=function(){var e=this;return this.getData().then(function(i){var o="box.pivot."+t.applicationId+"."+(e.options.className||"cls"),n=JSON.parse(t.Storage.getItem(o)||"false")||e.options.pivot||{},r=e.$(e.options.selectContainer);return n.onRefresh=n.onRefresh||e._onRefresh.bind(e),r.length||(r=e.$el),s(r).pivotUI(i,n,!0),t.UI.Control.prototype.render.call(this)})},g.prototype.getData=function(){var e=this,i={};return"function"==typeof this.options.getData?this.options.getData.call(this):this.options.className&&this.options.pipeline?(this.options.useMasterKey&&t.masterKey&&(i={useMasterKey:!0}),t.Cloud.run("data_aggregate",{className:this.options.className,pipeline:this.options.pipeline},i).then(function(t){return"function"==typeof e.options.processData?e.options.processData.call(e,t):e._processData(t)})):Promise.resolve([])},g.prototype._onRefresh=function(e){var i="box.pivot."+t.applicationId+"."+(this.options.className||"cls"),o=JSON.parse(JSON.stringify(e));!1!==this.options.noStatus&&(delete o.aggregators,delete o.renderers,delete o.rendererOptions,delete o.localeStrings,t.Storage.setItem(i,JSON.stringify(o)))},g.prototype._processData=function(e){var i=t._.map(e,function(e){var i={};return t._.each(e,function(o,n){"_id"===n?t._.each(e[n],function(t,e){i[e]=t}):i[n]=o}),i});return Promise.resolve(i)},t.UI.PivotTable=g,t.UI.PivotTable.defaults={},v.prototype=Object.create(u.prototype),v.prototype.constructor=v,v.prototype.save=function(){var e=this,i=e.options.useMasterKey&&t.masterKey?{useMasterKey:!0}:void 0;return e.update().then(function(){return e.trigger("saving"),e.model.save({},i)}).then(function(){return e._uploadFiles().then(function(){if(e.model.dirty())return e.model.save({},i)})}).then(function(){return Promise.all(s.each(e.childrens||[],function(t){return"function"==typeof t.saved?t.saved():Promise.resolve()}))}).then(function(){"function"==typeof e.options.onUpdated&&e.options.onUpdated(e),e.trigger("saved"),t.Utils.require("notification").then(function(){s.notify({message:p("Updated")+" !",icon:"fa fa-info-circle"},{type:"info"})}),!e.model&&e.model.id&&e._useEditorLock&&t.Socket.hasClient()&&(e._timerSync={className:e.model.className,objectId:e.model.id},e._lockSync())}).catch(function(i){"function"==typeof e.options.onError&&e.options.onError(i),i.validate||t.Utils.require("notification").then(function(){t.Trace.captureException(i)})})},v.prototype.initialize=function(){var e,i=this;if(t.UI.Control.prototype.initialize.call(this),!this.options.readOnly&&this.options.removeButtonClass?this.$(this.options.removeButtonClass).click(function(t){t.preventDefault(),s(this).hasClass("disabled")||"function"==typeof i.options.onRemove&&i.options.onRemove(i)}):this.$(this.options.removeButtonClass).hide(),this.options.cancelButtonClass&&this.$(this.options.cancelButtonClass).click(function(t){t.preventDefault(),i.wire().then(function(){"function"==typeof i.options.onCancel&&i.options.onCancel(i)})}),!this.options.readOnly&&this.options.createButtonClass?this.$(this.options.createButtonClass).click(function(e){var o=s(e.currentTarget);i.options.useMasterKey&&t.masterKey;if(e.preventDefault(),!s(this).hasClass("disabled"))return o.hide(),i.save().then(function(){o.show()})}):this.$(this.options.createButtonClass).hide(),this.$("[data-is-html]").length){var n=this.$("[data-is-html]");e=["summernote"],r&&e.push("css!"+CDN_ROOT+"/vendor/summernote/summernote"),this.p=this.p.then(function(){return t.Utils.require(e).then(function(){n.each(function(t,e){vd=s(this).data("bm-field"),vd&&vd.split("$")[0]===i.options.className&&(s(e).removeClass("input-group").find(l?".input-group-append":"button").hide(),i.wireSummernote(s(e)),s(e).summernote("code",s(e).val()))})})})}return this.$((l?".input-group-append":".input-group-btn")+" .btn").click(function(o){var n=s(o.currentTarget).parents(".input-group"),a=n.find("input"),c=a.data("bm-field");c&&c.split("$")[0]===i.options.className&&(e=["summernote"],o.preventDefault(),r&&e.push("css!"+CDN_ROOT+"/vendor/summernote/summernote"),n.removeClass("input-group").find(l?".input-group-append":"button").hide(),t.Utils.require(e).then(function(){i.wireSummernote(a),a.summernote("code",a.val())}))}),this.$("select[data-field-target]").each(function(){var e=s(this).data("bm-field"),o={};i.options.useMasterKey&&t.masterKey&&(o={useMasterKey:!0}),e&&e.split("$")[0]===i.options.className&&(e=e.split("$")[1],i.options.selects&&i.options.selects[e]&&(o=s.extend(o,i.options.selects[e])),i.selects[e]=new t.UI.Select(this,o))}),t._.isEmpty(i.selects)||(this.p=this.p.then(function(){return Promise.all(Object.keys(i.selects).map(function(t){return i.selects[t].p}))})),this.$('input[data-field-type="Number"]').each(function(e,o){var n=s(this).data("bm-field");n&&n.split("$")[0]===i.options.className&&t.Utils.inputDigitsOnly(s(this))}),this.$('[data-field-type="Date"]').length&&(this.p=this.p.then(function(){return t.Utils.require(["moment","bootstrap-datetimepiker"]).then(function(t){o=t[0],i.$(".form-group .input-group.date").datetimepicker({format:i.options.dateFormat})})})),this.p=this.p.then(function(){return i.$(".editor-lock .users-open-close").length&&t.Socket.hasClient()?(i._useEditorLock=!0,i.$(".editor-lock .users-open-close").click(function(t){t.preventDefault(),s(this).parent().toggleClass("open")}),t.Socket.client().then(function(t){t.on("edit",function(t){i._showLocks(t)})})):Promise.resolve()}),this.p},v.prototype.wire=function(e,i){var n=this,a=this.options.bindFilter||"[data-bm-field]";return e&&e.className&&e.className!==this.options.className?this.p:(this.model=e,this.__files=[],this.model&&this.model.id?(this.readOnly=this.options.readOnly,this.readOnly?(this.$(".readonly-field").show(),this.$(this.options.removeButtonClass).addClass("disabled"),this.$(this.options.createButtonClass).addClass("disabled")):(this.$(this.options.createButtonClass).html(this.options.updateButtonText),this.$(this.options.removeButtonClass).removeClass("disabled"),this.$(this.options.createButtonClass).removeClass("disabled"))):(this.readOnly=!1,this.$(".readonly-field").hide(),this.$(this.options.removeButtonClass).addClass("disabled"),this.$(this.options.createButtonClass).html(this.options.createButtonText),this.$(this.options.createButtonClass).removeClass("disabled")),this.$(a).each(function(){var i=this;n.p=n.p.then(function(){return function e(i,n,a){var c,d=s(this).data(),p=d.bmBind,u=d.bmDefault||"",h=[],f="change",m=i.options.bindFilter||"[data-bm-field]",y=d.bmField,g=Promise.resolve();if(d.bmUpdateOnly||!y||-1===y.indexOf("$"))return Promise.resolve();var v=this.nodeName;y=y.split("$");if(y[0]!==i.options.className)return Promise.resolve();y=y[1];p||("IMG"===v?(p="prop",h.push("src")):"INPUT"===v&&"checkbox"===this.type?(p="prop",h.push("checked")):p="INPUT"===v||"SELECT"===v||"TEXTAREA"===v?"val":"html");c=a||(n?n.get(y):u);c&&c.id&&c.className&&(c=c.id);if("string"==typeof c&&("String"===d.fieldType||0===p.indexOf("summernote;"))){if(c.trim().match(/^<[a-z][\s\S]*>/i)&&($input=s(this),$input.parents(".input-group").eq(0).removeClass("input-group").find(l?".input-group-append":"button").hide(),!s(this).data("summernote"))){var b=["summernote"];return r&&b.push("css!"+CDN_ROOT+"/vendor/summernote/summernote"),t.Utils.require(b).then(function(){i.wireSummernote($input),$input.summernote("code",c),f="summernote.change",$input.off(f).on(f,function(){var t=s(this).val();"function"==typeof i.trigger&&i.trigger("change",y,t),i.$(m+'[data-bm-field="'+s(this).data("bm-field")+'"]').not(this).each(function(){e.call(this,i,n,t)})})})}s(this).data("summernote")&&(p="summernote;code",f="summernote.change")}if("Files"===d.fieldTarget)return i.__files.push(this),g;"Date"===d.fieldType&&(c=c&&void 0!==o&&o(c).isValid()?o(c).format(i.options.dateFormat):c);"Object"===d.fieldType&&(c=c?JSON.stringify(c):c);i.selects&&i.selects[y]?i.selects[y].val(c):("Pointer"===d.fieldType&&(c=n&&"function"==typeof n.get&&n.get(y)&&"function"==typeof n.get(y).get?n.get(y).get(d.searchFor||"name"):c),-1!==p.indexOf(";")&&(p=p.split(";"),h.push(p[1]),p=p[0]),h.push(c),s.fn[p].apply(s(this),h),"INPUT"===v&&"checkbox"===this.type&&s(this).trigger("change"));void 0===d.bmWithNoChange&&s(this).off(f).on(f,function(){var t=s(this).val();"function"==typeof i.trigger&&i.trigger("change",y,t),i.$(m+'[data-bm-field="'+s(this).data("bm-field")+'"]').not(this).each(function(){e.call(this,i,n,t)})});return g}.call(i,n,e)})}),this.p=this.p.then(function(){var i=[],o=Promise.resolve();if(n.$(".file-placeholder .file-list").empty(),n.__files.length){if(e&&(s.each(n.__files,function(t,o){var n=s(o).data().bmField.split("$")[1],r=e.get(n);r&&i.push(r.id)}),i.length)){var r=new t.Query("Files");r.containedIn("objectId",i),o=r.find()}o=o.then(function(t){return Promise.all(s.map(n.__files,function(i){var o,r,a,l=s(i).data(),c=l.bmField.split("$")[1];if(e&&(r=e.get(c)))for(a=0;!o&&a<t.length;a++)t[a].id===r.id&&(o=t[a].toJSON());return n.files[l.bmField]||(n.files[l.bmField]={el:i,role:c}),n.renderImage(o,s(i))}))})}return o}),this.p=this.p.then(function(){return Promise.all(s.map(n.childrens||[],function(t){return"function"==typeof t.wire?t.wire(e,!0):Promise.resolve()}))}).then(function(){n.trigger("wired"),n.model&&n.model.id&&n._useEditorLock&&t.Socket.hasClient()&&(n._timerSync={className:n.model.className,objectId:n.model.id},n._lockSync())}),this.p)},v.prototype._lockSync=function(){var e=this;if(!this._timerSync)return e._showLocks();Promise.resolve().then(function(){return e.model&&!e.model.isNew()&&s.contains(document,e.$el[0])||(e._timerSync.leave=!0),t.Socket.client().then(function(t){return new Promise(function(i,o){t.emit("edit",e._timerSync,function(t){return e._timerSync.leave&&delete e._timerSync,e._showLocks(t).then(i,o)})})})}).then(function(){setTimeout(e._lockSync.bind(e),e.options.editSyncTimer)},function(){setTimeout(this._lockSync.bind(this),e.options.editSyncTimer)})},v.prototype._showLocks=function(t){var e=[],i="";return t&&this.model&&this.model.id===t.object.objectId?(s.each(t,function(t,o){"object"!==t&&(e.push(o),i+='<li><i class="fa fa-user"></i> {username}</li>'.format(o.editor.user))}),e.length>1?(this.$(".editor-lock").show(),this.$(".editor-lock .lock-list-body ul").html(i)):this.$(".editor-lock").hide(),Promise.resolve()):(this.$(".editor-lock").hide(),Promise.resolve())},v.prototype.addChilds=function(t){this.childrens=this.childrens||[],t.parent=this,this.childrens.push(t)},v.prototype._uploadFiles=function(){var e=this;return Promise.all(s.map(this.files,function(i){return s(i.el).val()?new Promise(function(o,n){var r,a,l=s(i.el).parents(".input-file"),c=(l.find('input[type="file"]')||[])[0];if(c&&c.files&&c.files.length)return r=c.files[0],l.find(".file-edit").hide(),l.find(".fileinput-button").hide(),l.find(".progress").show(),a={role:i.role,className:e.options.className,name:r.name,contentType:r.type||"application/octet-stream"},e.model&&e.model.id&&(a.objectId=e.model.id),t.Utils.upload(r,a,function(t,e,i){l.find(".progress span").html(i+"%"),l.find(".progress .progress-bar").css({width:i+"%"})}).then(function(t){return e.model&&e.model.set(i.role,t),t}).then(function(t){l.find(".file-edit").show(),l.find(".file-edit").val(""),l.find(".fileinput-button").show(),l.find(".progress").hide(),l.find('input[type="file"]').val(""),e.renderImage(t?t.toJSON():null,l).then(o,n)}).catch(function(t){l.find(".progress").hide(),l.find(".file-edit").show(),l.find(".fileinput-button").show(),n(t)})}):Promise.resolve()})).then(function(){e.options.useMasterKey&&t.masterKey}).catch(function(i){t.Utils.require("notification").then(function(){t.Trace.captureException(i)}),"function"==typeof e.options.onError&&e.options.onError(i)})},v.prototype.renderImage=function(e,i){var o=this,n=Promise.resolve();if(e){var s=e.url?e.url:t.serverURL+"/storage/"+t.applicationId+"/"+e.objectId,r=i.parents(".file-placeholder").find(".file-list");r.length||(i.parents(".file-placeholder").prepend('<ul class="file-list"></ul>'),r=i.parents(".file-placeholder").find(".file-list")),r.empty(),r.append(o.options.imageFormat.format({display:e.contentType&&0===e.contentType.indexOf("image/")?'<img src="'+s+'">':'<i class="fa fa-file"></i>',name:e.name||e.fileName,id:e.objectId,url:s,size:(e.size||0).toByteSize()})),r.find("a.text-danger:last").click(function(n){var s=i.data();n.preventDefault(),t.Utils.require("bootstrap-dialog").then(function(n){n.confirm({title:p("Warning"),type:n.TYPE_WARNING,message:"<i class='fa "+(c?"fa-trash-alt":"fa-trash-o")+" text-danger'></i> "+p("Remove file")+" <i>"+(e.name||e.fileName)+"</i> ?",closable:!0,btnCancelLabel:'<i class="fa fa-ban"></i> '+p("Cancel"),btnOKLabel:'<i class="fa '+(c?"fa-trash-alt":"fa-trash-o")+'"></i> '+p("Delete"),btnOKClass:"btn-danger",callback:function(e){if(e){var n,r=s.bmField.split("$")[1];return o.options.useMasterKey&&t.masterKey&&{useMasterKey:!0},n=o.model.get(r),o.model.set(r,null),n&&n.set("purged",!0),t.Object.saveAll([n,o.model]).then(function(){o.renderImage(null,i)})}}})})})}else i.parents(".file-placeholder").find(".file-list").remove();return n},v.prototype.validate=function(){var e,i=this,o=(this.options.bindFilter||"[data-bm-field]")+"[data-bm-required]",n=Promise.resolve();return this.$(o).each(function(){var i=s(this).data(),o=i.bmBind,r=[];if(!o){var a=this.nodeName;"IMG"===a?(o="prop",r.push("src")):"INPUT"===a&&"checkbox"===this.type?(o="prop",r.push("checked")):o="INPUT"===a||"SELECT"===a||"TEXTAREA"===a?"val":"html"}s(this).data("summernote")&&(o="summernote;code"),-1!==o.indexOf(";")&&(o=o.split(";"),r.push(o[1]),o=o[0]),s.fn[o].apply(s(this),r)||(e=e||{field:i.bmField,validate:!0,message:i.bmRequiredError||i.bmField.split("$").join(" ")+" "+p("is required")},n=n.then(function(){return t.Utils.require("notification").then(function(){s.notify({message:i.bmRequiredError||i.bmField.split("$").join(" ")+" "+p("is required"),icon:"fa fa-exclamation-circle"},{type:"danger",timer:5e3})})}))}),e&&(n=n.then(function(){return Promise.reject(e)})),n.then(function(){return Promise.all(s.map(i.childrens||[],function(t){return t.validate()}))})},v.prototype.wireSummernote=function(e,i){var o=this;e.data("summernote")||(o.options.summernote=o.options.summernote||{},t._.defaults(o.options.summernote,{height:"300px",focus:!1,tabsize:2,dialogsInBody:!0,callbacks:{onChange:function(t){s(this).val(t)},onImageUpload:function(i){var n=s(this).data("summernote").modules.editor,r=o.options.useMasterKey&&t.masterKey?{useMasterKey:!0}:void 0,a=Promise.resolve(),l=o.options.fileRole||!!e.data("bm-field")&&e.data("bm-field").split("$")[1]||"attachment",c=i[0];return o.model&&o.model.isNew()&&(a=a.then(function(){return a.save({},r)})),a.then(function(){var i;(o.options.fileRole||e.data("bm-field"))&&e.data("bm-field").split("$")[1];return e.parent().find(".summer-progress").show(),i={role:l,className:o.options.className,name:c.name,inline:!0,contentType:c.type||"application/octet-stream"},o.model&&o.model.id&&(i.objectId=o.model.id),t.Utils.upload(c,i,function(t,i,o){e.parent().find(".summer-progress span").html(o+"%"),e.parent().find(".summer-progress .progress-bar").css({width:o+"%"})}).then(function(i){n.restoreRange(),i&&n.insertImage(i.get("url")?i.get("url"):t.serverURL+"/storage/"+t.applicationId+"/"+i.id,i.get("name")),e.parent().find(".summer-progress").hide()}).catch(function(i){e.parent().find(".summer-progress").hide(),n.restoreRange(),t.Trace.reportError(i)})})}}}),e.summernote(o.options.summernote),e.parent().css("position","relative"),e.parent().append(o.options.progressBar))},v.prototype.update=function(){var e,i=this,n=this.options.bindFilter||"[data-bm-field]";return this.model||this.options.className?(e=this.validate(),this.model||(this.$('input[name="objectId"]').val()?this.model=new t.Object.fromJSON({className:this.options.className,objectId:this.$('input[name="objectId"]').val()}):this.model=new t.Object(this.options.className)),this.$(n).each(function(){var n,r,a=s(this).data(),l=a.bmBind,c=[];if(!(a.bmDisplayOnly||"Files"===a.fieldTarget&&"Pointer"===a.fieldType)&&(n=(n=-1===a.bmField.indexOf(";")?a.bmField:a.bmField.split(";")).split("$"))[0]===i.options.className){if(n=n[1],!l){var d=this.nodeName;if(-1!==(i.options.readOnlyBind||["P","DIV"]).indexOf(d))return;"IMG"===d?(l="prop",c.push("src")):"INPUT"===d&&"checkbox"===this.type?(l="prop",c.push("checked")):l="INPUT"===d||"SELECT"===d||"TEXTAREA"===d?"val":"html"}if(s(this).data("summernote")&&(l="summernote;code"),-1!==l.indexOf(";")&&(l=l.split(";"),c.push(l[1]),l=l[0]),r=s.fn[l].apply(s(this),c),"Number"===a.fieldType||"slider"===a.fieldType){var p=parseFloat(r);r=isNaN(p)?null:p}else"Boolean"===a.fieldType&&"string"==typeof r?r="true"===r.toLowerCase():"Pointer"===a.fieldType?r=r?t.Object.fromJSON({className:a.fieldTarget,objectId:r}):null:"String"===a.fieldType?r=r.trim():"Date"===a.fieldType?r=r&&void 0!==o&&o(r,i.options.dateFormat).isValid()?o(r,i.options.dateFormat).toDate():null:"Object"===a.fieldType&&(r=r?JSON.parse(r):null);"Relation"===a.fieldType?i.selects[n]&&(e=e.then(function(){return i.selects[n].syncRelation(i.model)})):i.model.set(n,r)}}),e.then(function(){return Promise.all(s.each(i.childrens||[],function(t){return"function"==typeof t.update?t.update():Promise.resolve()}))})):Promise.reject(new Error("Invalid binding"))},v.prototype.destroy=function(){var e=this,i=this.childrens||[];return s.each(this.selects,function(t,e){"function"==typeof e.destroy&&i.push(e.destroy())}),s.when.apply(s,i).then(function(){return t.UI.Control.prototype.destroy.call(e)})},t.UI.Editor=v,t.UI.Editor.defaults=s.extend({},t.UI.Control.defaults,{cancelButtonClass:"footer .btn-default",createButtonClass:"footer .btn-success",removeButtonClass:"footer .btn-danger",createButtonText:'<i class="fa fa-plus"></i> '+p("Create"),updateButtonText:'<i class="fa '+(c?"fa-save":"fa-floppy-o")+'"></i> '+p("Update"),imageFormat:'<li data-object-id="{id}"><div class="well well-sm"><span>{display}</span><br><strong>{name}</strong><br>{size}<br><a href="{url}" target="_blank"><i class="fa fa-download"></i> '+p("Download")+'</a>  | <a href="#" data-file-id="{id}" class="text-danger"><i class="fa fa-times"></i> '+p("Remove")+"</a></div></li>",progressBar:'<div class="summer-progress" style="display:none"><div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;"><span>0%</span></div></div>',bindFilter:"[data-bm-field]",dateFormat:"DD-MM-YYYY",editSyncTimer:3e4}),b.prototype=Object.create(v.prototype),b.prototype.constructor=b,b.prototype.wire=function(e,i){var o=this;return t.UI.Editor.prototype.wire.call(o,new t.Object(o.options.className),i),i?(this.p=this.p.then(function(){if(e&&!e.isNew())return o.query||o.options.query?Promise.resolve(o.query||o.options.query):o.getQuery(e,i)}).then(function(e){var i=o.options.useMasterKey&&t.masterKey?{useMasterKey:!0}:void 0;return e?e.find(i):null}).then(function(t){o.render(t)}),this.p):this.p},b.prototype.getQuery=function(e,i){var o=new t.Query(this.options.className);return o.equalTo("targetClass",e.className),o.equalTo("targetId",e.id),o},b.prototype.initialize=function(){var e=this;return t.UI.Editor.prototype.initialize.call(e),this.$el.find(this.options.uploadButtonClass).on("click",function(i){var o=t.$(this),n=e.$el.find(".input-file"),r=(n.find('input[type="file"]')||[])[0];return i.preventDefault(),r&&r.files&&r.files.length?e.parent&&e.parent.model?(o.hide(),(e.parent.model.isNew()?e.parent.save():Promise.resolve()).then(function(){return n.find(".file-edit").hide(),n.find(".fileinput-button").hide(),n.find(".progress").show(),t.Utils.upload(r,{className:e.parent.model.className,role:"image",objectId:e.parent.model.id},function(t,e,i){n.find(".progress span").html(i+"%"),n.find(".progress .progress-bar").css({width:i+"%"})})}).then(function(i){return e.update().then(function(){var o=e.model._getSaveJSON();return t._.each(t._.keys(o),function(t){i.set(t,e.model.get(t))}),i.save()}).then(function(){n.find(".progress").hide(),n.find('input[type="file"]').val(""),n.find(".file-edit").val(""),n.find(".file-edit").show(),n.find(".fileinput-button").show(),e.wire(),e.render([i],!0),o.show()})}).catch(function(e){n.find(".progress").hide(),n.find(".file-edit").show(),n.find(".fileinput-button").show(),o.show(),t.Trace.captureException(e)})):void 0:t.Utils.require("notification").then(function(){s.notify({message:e.options.bmRequiredError||p("file is required"),icon:"fa fa-exclamation-circle"},{type:"danger",timer:5e3})})}),this.p},b.prototype.renderFiles=function(e,i){var o=this,n=this.$el.find(".file-list"),s=e&&e.length?t._.map(e,function(e){var i=e.toJSON(),n=i.url?i.url:t.serverURL+"/storage/"+t.applicationId+"/"+i.objectId,s=o.options.renderFile?o.options.renderFile(e):Object.assign({},i,{display:i.contentType&&0===i.contentType.indexOf("image/")?'<img src="'+n+'">':'<i class="fa fa-file"></i>',name:i.name||i.fileName,id:i.objectId,url:n,size:(i.size||0).toByteSize()});return o.options.imageFormat.format(s)}).join(""):o.options.imageEmpty;return i?(n.find(o.options.emptyClass).remove(),n.append(s)):(n.empty(),n.html(s)),e&&e.length?(n.find(o.options.removeButtonClass).slice(-e.length).on("click",function(e){var i=t.$(this).parents("[data-object-id]").eq(0);e.preventDefault(),t.Utils.require("bootstrap-dialog").then(function(e){e.confirm({title:p("Warning"),type:e.TYPE_WARNING,message:"<i class='fa "+(c?"fa-trash-alt":"fa-trash-o")+" text-danger'></i> "+p("Remove file")+"?",closable:!0,btnCancelLabel:'<i class="fa fa-ban"></i> '+p("Cancel"),btnOKLabel:'<i class="fa '+(c?"fa-trash-alt":"fa-trash-o")+'"></i> '+p("Delete"),btnOKClass:"btn-danger",callback:function(e){e&&t.Object.fromJSON({className:o.options.className,objectId:i.data("object-id")}).destroy().then(function(){var t=i.parent().find("[data-object-id]").length;i.remove(),t<2&&o.render([])})}})})}),this.p):this.p},b.prototype.render=function(e,i){return t.UI.Editor.prototype.render.call(this),"function"==typeof this.options.renderFiles?this.options.renderFiles.call(this,e,i):this.renderFiles(e,i)},t.UI.Gallery=b,t.UI.Gallery.defaults=s.extend({},t.UI.Editor.defaults,{className:"Files",removeButtonClass:".text-danger",uploadButtonClass:".btn-success",emptyClass:".empty",imageEmpty:'<li class="empty"><div class="well well-sm">'+p("No files")+"</div></li>"}),w.prototype=Object.create(u.prototype),w.prototype.constructor=w,w.prototype._getEditor=function(t){var e=this;return this.editor?Promise.resolve(this.editor):this._editorLoader?this._editorLoader:(t.events&&("function"==typeof t.events.initialized&&(t.events.initialized=function(){e.trigger("initialized",e)}),"function"==typeof t.events.wired&&(t.events.wired=function(){e.trigger("wired",e)})),this._editorLoader="function"==typeof e.options.editor?e.options.editor(t).then(function(t){return e.editor=t,e.editor.on("wired",function(){e.trigger("wired",e)}),e.editor.p}):new Promise(function(i,o){var n=e.$el.prop("id");return e.editor=e.options.editor||new v(this.$(e.options.editorId?e.options.editorId:n?"#"+n+"-form":"form.box-editor"),t),e.editor.p.then(i,o)}),this._editorLoader)},w.prototype.initialize=function(){var e,i=this,o=this.$el.prop("id"),n={onAction:this.onAction.bind(this),onUpdated:function(){i.grid.reload(),i.trigger("saved")},onCreate:function(){var e=new t.Object(i.options.className);i.wire(e)},onCancel:function(){i.grid.show(),i.editor.hide(),i.trigger("canceled"),s("html, body").animate({scrollTop:i.grid.$el.offset().top-(i.options.scrollTopOffset||150)},200)}},r=s.extend({},n,this.options);return this.grid=this.options.grid||new y(this.$(this.options.gridId?this.options.gridId:o?"#"+o+"-table":"table.box-table"),r),this._editorOptions=r,e=d?Promise.resolve():this._getEditor(this._editorOptions),Promise.all([e,this.grid.p||Promise.resolve()]).then(function(){return t.UI.Control.prototype.initialize.call(i)})},w.prototype.onAction=function(t,e,i){t.fieldId&&t.objectId&&this.wire(e)},w.prototype.wire=function(t){var e=this;this._getEditor(this._editorOptions).then(function(){e.grid.hide(),e.editor.wire(t),e.editor.$el.removeClass("hidden").show()})},w.prototype.showGrid=function(t){this.editor.hide(),this.grid.show(),t&&this.grid.reload()},w.prototype.destroy=function(){var e=this,i=[];return this.editor&&"function"==typeof this.editor.destroy&&i.push(this.editor.destroy()),this.grid&&"function"==typeof this.grid.destroy&&i.push(this.grid.destroy()),s.when.apply(s,i).then(function(){return t.UI.Control.prototype.destroy.call(e)})},t.UI.DataSet=w,t.UI.DataSet.defaults={}});